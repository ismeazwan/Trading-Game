<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crypto Wallet</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
    </style>
</head>
<body class="bg-gray-900 text-white">

    <div class="container mx-auto p-4 max-w-6xl">
        <header class="bg-gray-800 p-4 rounded-lg mb-4 flex flex-wrap justify-between items-center shadow-lg">
            <div>
                <h1 class="text-2xl font-bold">Crypto Wallet Saya</h1>
                 <div class="flex space-x-4 mt-1">
                    <a href="trading_platform.html" class="text-sm text-purple-400 hover:underline">&larr; Ke Platform Trading</a>
                    <a href="crypto_exchange.html" class="text-sm text-cyan-400 hover:underline">Ke Crypto Exchange &rarr;</a>
                </div>
            </div>
            <div class="text-right mt-4 sm:mt-0">
                <p class="text-gray-400 text-sm">Total Nilai Aset</p>
                <p id="total-portfolio-value" class="text-3xl font-bold text-cyan-400">Rp 0</p>
            </div>
             <div>
                <button id="reset-button" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-3 text-xs sm:text-sm rounded mt-2 sm:mt-0">Reset Wallet</button>
            </div>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-5 gap-4">
            
            <!-- Kolom Portofolio -->
            <div class="lg:col-span-3 bg-gray-800 p-4 rounded-lg shadow-lg">
                <h2 class="text-xl font-bold mb-4">Aset Saya</h2>
                <div id="portfolio-list" class="space-y-3 max-h-[60vh] overflow-y-auto">
                    <p class="text-gray-500">Dompet Anda kosong. Terima koin dari platform lain untuk memulai.</p>
                </div>
            </div>

            <!-- Kolom Aksi -->
            <div class="lg:col-span-2 bg-gray-800 p-4 rounded-lg shadow-lg">
                <div class="border-b border-gray-700 mb-4">
                    <nav class="flex space-x-4" id="action-tabs">
                        <button class="action-tab-btn active py-2 px-4 text-sm font-medium border-b-2 border-purple-500" data-tab="send">Kirim</button>
                        <button class="action-tab-btn py-2 px-4 text-sm font-medium border-b-2 border-transparent text-gray-400" data-tab="receive">Terima</button>
                    </nav>
                </div>
                
                <!-- Panel Kirim -->
                <div id="send-panel" class="space-y-4">
                    <h3 class="text-lg font-semibold">Kirim Aset</h3>
                    <div>
                        <label class="text-sm text-gray-400">Aset</label>
                        <select id="send-coin-select" class="w-full bg-gray-700 p-2 rounded mt-1"></select>
                    </div>
                    <div>
                        <label class="text-sm text-gray-400">Jumlah</label>
                        <input id="send-amount" type="number" placeholder="0" class="w-full bg-gray-700 p-2 rounded mt-1">
                        <p class="text-xs text-gray-500 mt-1">Dimiliki: <span id="send-owned-balance">0</span></p>
                    </div>
                    <div>
                        <label class="text-sm text-gray-400">Ke Platform</label>
                        <select id="send-destination-select" class="w-full bg-gray-700 p-2 rounded mt-1">
                            <option value="crypto_exchange">Crypto Exchange</option>
                            <option value="trading_platform">Trading Platform</option>
                        </select>
                    </div>
                    <button id="execute-send-btn" class="w-full bg-purple-600 hover:bg-purple-700 font-bold py-3 rounded transition duration-200">Kirim Sekarang</button>
                </div>

                <!-- Panel Terima -->
                <div id="receive-panel" class="hidden text-center space-y-4 pt-8">
                     <h3 class="text-lg font-semibold">Alamat Wallet Anda</h3>
                     <div class="bg-gray-900 p-4 rounded-lg break-words">
                         <p id="wallet-address" class="text-sm text-green-400"></p>
                     </div>
                     <p class="text-xs text-gray-500">Gunakan alamat ini untuk menerima aset dari platform lain.</p>
                </div>
            </div>
        </div>

        <!-- Riwayat Transaksi -->
        <div class="mt-4 bg-gray-800 p-4 rounded-lg shadow-lg">
            <h2 class="text-xl font-bold mb-4">Riwayat Transaksi</h2>
            <div id="history-list" class="space-y-2 max-h-64 overflow-y-auto">
                <p class="text-gray-500">Belum ada transaksi.</p>
            </div>
        </div>
    </div>
    
    <div id="toast" class="fixed bottom-5 right-5 bg-green-500 text-white py-2 px-4 rounded-lg shadow-lg transition-opacity duration-300 opacity-0"></div>

    <script>
    // --- STATE & SETUP ---
    const defaultWalletState = {
        portfolio: {}, // e.g., { BTC: { quantity: 1.5 }, ETH: { quantity: 0.5 } }
        coinDefinitions: {}, // Stores coin metadata like { BTC: { name: "Bitcoin", ... } }
        history: [],   // e.g., { id, type, coinId, amount, source/dest, date }
        walletAddress: ''
    };
    let walletState = {};
    let marketPrices = {};
    const USD_TO_IDR = 16000; // Kurs konversi untuk harga dari platform trading

    // --- ELEMENT CACHING ---
    const totalPortfolioValueEl = document.getElementById('total-portfolio-value');
    const portfolioListEl = document.getElementById('portfolio-list');
    const historyListEl = document.getElementById('history-list');
    const sendCoinSelect = document.getElementById('send-coin-select');
    const sendAmountInput = document.getElementById('send-amount');
    const sendOwnedBalanceEl = document.getElementById('send-owned-balance');
    const sendDestinationSelect = document.getElementById('send-destination-select');
    const executeSendBtn = document.getElementById('execute-send-btn');
    const walletAddressEl = document.getElementById('wallet-address');

    // --- FORMATTERS ---
    function formatLargeNumber(num) {
        if (isNaN(num)) return '0';
        if (num > 0 && num < 1000) return num.toLocaleString('id-ID', { maximumFractionDigits: 8 });
        const suffixes = ['', ' Rb', ' Jt', ' M', ' T', ' Ku'];
        const i = num === 0 ? 0 : Math.floor(Math.log10(Math.abs(num)) / 3);
        if (i >= suffixes.length) return num.toExponential(2);
        const value = (num / Math.pow(1000, i));
        return value.toFixed(2).replace(/\.0+$/, '') + suffixes[i];
    }
    function formatRupiah(num) {
        if (isNaN(num)) num = 0;
        return `Rp ${formatLargeNumber(num)}`;
    }

    // --- STATE MANAGEMENT ---
    function loadState() {
        const saved = localStorage.getItem('cryptoWalletSaveData');
        const cleanState = JSON.parse(JSON.stringify(defaultWalletState));
        walletState = saved ? {...cleanState, ...JSON.parse(saved)} : cleanState;
        
        if (!walletState.walletAddress) {
            walletState.walletAddress = 'W' + Date.now().toString(36) + Math.random().toString(36).substr(2).toUpperCase();
        }
    }

    function saveState() {
        localStorage.setItem('cryptoWalletSaveData', JSON.stringify(walletState));
    }

    // --- CORE LOGIC ---
    function syncMarketPrices() {
        try {
            // Fetch prices from both platforms
            const exchangeData = JSON.parse(localStorage.getItem('cryptoExchangeData'));
            const tradingPlatformData = JSON.parse(localStorage.getItem('tradingPlatformSaveData'));

            const exchangePrices = (exchangeData && exchangeData.marketPrices) ? exchangeData.marketPrices : {};
            const platformPrices = (tradingPlatformData && tradingPlatformData.marketPrices && tradingPlatformData.marketPrices.crypto) ? tradingPlatformData.marketPrices.crypto : {};

            // Combine prices, giving priority to Trading Platform for shared coins.
            // This ensures the wallet reflects the prices from the professional trading chart.
            marketPrices = { ...exchangePrices, ...platformPrices };

        } catch (e) {
            console.warn("Could not sync market prices.", e);
        }
    }
    
    function showToast(message) {
        const toast = document.getElementById('toast');
        toast.textContent = message;
        toast.style.opacity = '1';
        setTimeout(() => {
            toast.style.opacity = '0';
        }, 3000);
    }

    function checkIncomingTransfers() {
        const transferJSON = localStorage.getItem('cryptoTransfer');
        if (transferJSON) {
            try {
                const transfer = JSON.parse(transferJSON);
                if (transfer.platform === 'crypto_wallet') {
                    // Add to portfolio
                    const holding = walletState.portfolio[transfer.coinId] || { quantity: 0 };
                    holding.quantity += transfer.amount;
                    walletState.portfolio[transfer.coinId] = holding;

                    // Save coin definition if it's new
                    if (!walletState.coinDefinitions[transfer.coinId] && transfer.coinData) {
                        walletState.coinDefinitions[transfer.coinId] = transfer.coinData;
                    }

                    // Add to history
                    const sourcePlatformNameMap = {
                        'crypto_exchange': 'Exchange',
                        'trading_platform': 'Platform Trading'
                    };
                    const sourcePlatform = sourcePlatformNameMap[transfer.sourcePlatform] || 'Unknown';
                    
                    walletState.history.unshift({
                        id: transfer.transferId,
                        type: 'in',
                        coinId: transfer.coinId,
                        amount: transfer.amount,
                        source: sourcePlatform,
                        date: new Date().toISOString()
                    });

                    localStorage.removeItem('cryptoTransfer');
                    saveState();
                    renderAll();
                    showToast(`Menerima ${formatLargeNumber(transfer.amount)} ${transfer.coinId} dari ${sourcePlatform}!`);
                }
            } catch (e) {
                console.error("Gagal memproses transfer masuk:", e);
                localStorage.removeItem('cryptoTransfer');
            }
        }
    }

    // --- RENDERING ---
    function renderAll() {
        renderPortfolio();
        renderHistory();
        renderSendPanel();
        walletAddressEl.textContent = walletState.walletAddress;
    }
    
    function renderPortfolio() {
        const coinIds = Object.keys(walletState.portfolio);
        if (coinIds.length === 0) {
            portfolioListEl.innerHTML = `<p class="text-gray-500">Dompet Anda kosong. Terima koin dari platform lain untuk memulai.</p>`;
            totalPortfolioValueEl.textContent = formatRupiah(0);
            return;
        }

        let totalValueRupiah = 0;
        
        // Determine if the primary price source is USD-based (from trading platform)
        // A simple check on a major coin's price magnitude can determine this.
        const isUsdSource = (marketPrices['BTC'] && marketPrices['BTC'] < 1000000) || (marketPrices['USDT'] && marketPrices['USDT'] < 1000);

        portfolioListEl.innerHTML = coinIds.map(id => {
            const holding = walletState.portfolio[id];
            if(holding.quantity <= 0) return '';
            
            const price = marketPrices[id]?.price || 0;
            let valueInRupiah;
            let displayPriceInRupiah;

            if (isUsdSource) {
                // If source is USD, convert price to IDR for all calculations
                valueInRupiah = holding.quantity * price * USD_TO_IDR;
                displayPriceInRupiah = price * USD_TO_IDR;
            } else {
                // If source is IDR, use prices as is
                valueInRupiah = holding.quantity * price;
                displayPriceInRupiah = price;
            }
            
            totalValueRupiah += valueInRupiah;

            return `
                <div class="bg-gray-700/50 p-3 rounded-lg flex justify-between items-center">
                    <div>
                        <p class="font-bold text-lg">${id}</p>
                        <p class="text-sm text-gray-400">${formatLargeNumber(holding.quantity)}</p>
                    </div>
                    <div class="text-right">
                        <p class="font-semibold">${formatRupiah(valueInRupiah)}</p>
                        <p class="text-xs text-gray-500">@ ${formatRupiah(displayPriceInRupiah)}</p>
                    </div>
                </div>
            `;
        }).join('');
        totalPortfolioValueEl.textContent = formatRupiah(totalValueRupiah);
    }


    function renderHistory() {
        if (walletState.history.length === 0) {
            historyListEl.innerHTML = `<p class="text-gray-500">Belum ada transaksi.</p>`;
            return;
        }
        historyListEl.innerHTML = walletState.history.map(tx => {
            const isSend = tx.type === 'out';
            const color = isSend ? 'text-red-400' : 'text-green-400';
            const sign = isSend ? '-' : '+';
            const target = isSend ? `Ke ${tx.destination}` : `Dari ${tx.source}`;
            const date = new Date(tx.date).toLocaleString('id-ID');

            return `
                <div class="bg-gray-900/50 p-2 rounded-md flex justify-between items-center text-sm">
                    <div>
                        <p class="font-bold ${color}">${sign} ${formatLargeNumber(tx.amount)} ${tx.coinId}</p>
                        <p class="text-xs text-gray-500">${target}</p>
                    </div>
                    <p class="text-xs text-gray-500">${date}</p>
                </div>
            `;
        }).join('');
    }
    
    function renderSendPanel() {
        const ownedCoins = Object.keys(walletState.portfolio).filter(id => walletState.portfolio[id].quantity > 0);
        if (ownedCoins.length === 0) {
            sendCoinSelect.innerHTML = `<option value="">Tidak ada koin untuk dikirim</option>`;
        } else {
            const currentSelection = sendCoinSelect.value;
            sendCoinSelect.innerHTML = ownedCoins.map(id => `<option value="${id}" ${id === currentSelection ? 'selected' : ''}>${id}</option>`).join('');
        }
        updateSendBalance();
    }

    function updateSendBalance() {
        const selectedCoin = sendCoinSelect.value;
        const balance = walletState.portfolio[selectedCoin]?.quantity || 0;
        sendOwnedBalanceEl.textContent = formatLargeNumber(balance);
    }


    // --- EVENT LISTENERS ---
    document.getElementById('action-tabs').addEventListener('click', (e) => {
        if (e.target.tagName !== 'BUTTON') return;
        document.querySelectorAll('.action-tab-btn').forEach(btn => {
            btn.classList.remove('active', 'border-purple-500');
            btn.classList.add('border-transparent', 'text-gray-400');
        });
        e.target.classList.add('active', 'border-purple-500');
        e.target.classList.remove('border-transparent', 'text-gray-400');
        
        const tab = e.target.dataset.tab;
        document.getElementById('send-panel').classList.toggle('hidden', tab !== 'send');
        document.getElementById('receive-panel').classList.toggle('hidden', tab !== 'receive');
    });

    sendCoinSelect.addEventListener('change', updateSendBalance);

    executeSendBtn.addEventListener('click', () => {
        const coinId = sendCoinSelect.value;
        const amount = parseFloat(sendAmountInput.value);
        const destination = sendDestinationSelect.value;

        if (!coinId || isNaN(amount) || amount <= 0) {
            alert("Harap isi semua kolom dengan benar.");
            return;
        }

        const holding = walletState.portfolio[coinId];
        if (!holding || holding.quantity < amount) {
            alert("Saldo koin tidak mencukupi.");
            return;
        }
        
        const coinData = walletState.coinDefinitions[coinId];
        if (!coinData) {
            alert(`Detail data untuk ${coinId} tidak ditemukan. Transfer dibatalkan.`);
            return;
        }

        // Deduct from wallet
        holding.quantity -= amount;
        if(holding.quantity < 1e-9) delete walletState.portfolio[coinId];

        // Create transfer data for other platforms
        const transferData = {
            platform: destination,
            sourcePlatform: 'crypto_wallet',
            transferId: `transfer-${Date.now()}`,
            coinId: coinId,
            amount: amount,
            coinData: coinData // Include coin metadata for the receiving platform
        };
        localStorage.setItem('cryptoTransfer', JSON.stringify(transferData));

        // Add to history
         const destinationNameMap = {
            'crypto_exchange': 'Exchange',
            'trading_platform': 'Platform Trading'
        };
        walletState.history.unshift({
            id: transferData.transferId,
            type: 'out',
            coinId: coinId,
            amount: amount,
            destination: destinationNameMap[destination] || 'Unknown',
            date: new Date().toISOString()
        });
        
        showToast(`Mengirim ${formatLargeNumber(amount)} ${coinId}...`);
        sendAmountInput.value = '';
        saveState();
        renderAll();
    });

    document.getElementById('reset-button').addEventListener('click', () => {
        if (confirm("Apakah Anda yakin ingin mereset wallet ini? Semua aset akan hilang.")) {
            localStorage.removeItem('cryptoWalletSaveData');
            localStorage.removeItem('cryptoTransfer');
            location.reload();
        }
    });

    // --- INIT & GAME LOOP ---
    loadState();
    syncMarketPrices();
    renderAll();

    setInterval(() => {
        syncMarketPrices();
        checkIncomingTransfers();
        renderPortfolio(); // Re-render portfolio to reflect price changes
    }, 1000);

    </script>
</body>
</html>

