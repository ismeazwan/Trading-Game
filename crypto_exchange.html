<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crypto Exchange</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js and required plugins for candlestick chart -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/luxon@^2.0.2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon@^1.0.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-financial@^0.1.1"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style> 
        body { font-family: 'Inter', sans-serif; } 
        .tab.active { border-color: #F97316; background-color: #374151; } 
        .trade-tab.active { border-color: #F97316; color: white; }
        #news-ticker {
            animation: marquee-scroll linear infinite;
        }
        @keyframes marquee-scroll {
            from { transform: translateX(0); }
            to { transform: translateX(-50%); } /* Animate to half, since content is duplicated */
        }
        /* Hide scrollbar for tab navigation */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }
    </style>
</head>
<body class="bg-gray-900 text-white">

    <div class="container mx-auto p-2 md:p-4 max-w-7xl">
        <!-- Responsive Header -->
        <header class="bg-gray-800 p-4 rounded-lg mb-4 flex flex-col md:flex-row md:justify-between md:items-center shadow-lg gap-4 md:gap-0">
            <div>
                <h1 class="text-xl md:text-2xl font-bold text-center md:text-left">Crypto Exchange</h1>
                <a href="index.html" class="text-sm text-purple-400 hover:underline block text-center md:text-left">&larr; Kembali ke Idle Tycoon</a>
            </div>
            <div class="flex items-center justify-center flex-wrap md:justify-end gap-4 md:gap-6 w-full md:w-auto">
                <div class="text-right">
                    <p class="text-gray-400 text-xs md:text-sm">Saldo Tunai</p>
                    <p id="balance" class="text-lg md:text-2xl font-bold text-green-400">Rp 0</p>
                </div>
                 <div class="text-right">
                    <p class="text-gray-400 text-xs md:text-sm">Nilai Portofolio</p>
                    <p id="portfolio-value" class="text-lg md:text-2xl font-bold text-cyan-400">Rp 0</p>
                </div>
                <div>
                    <button id="reset-button" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-3 text-xs md:text-sm rounded">Reset</button>
                </div>
            </div>
        </header>

        <div id="news-ticker-container" class="bg-gray-700 rounded-lg mb-4 overflow-hidden whitespace-nowrap">
             <div id="news-ticker" class="py-2 text-sm text-yellow-300">
                <span>Berita pasar akan muncul di sini...</span>
            </div>
        </div>

        <!-- Scrollable Tabs for Mobile -->
        <div class="mb-4 border-b border-gray-700">
            <div class="overflow-x-auto whitespace-nowrap no-scrollbar">
                <nav class="flex space-x-1 md:space-x-4">
                    <button class="tab active py-2 px-3 md:px-4 text-sm font-medium border-b-2" data-tab="trade">Perdagangan</button>
                    <button class="tab border-transparent py-2 px-3 md:px-4 text-sm font-medium border-b-2" data-tab="invest">Investasi</button>
                    <button class="tab border-transparent py-2 px-3 md:px-4 text-sm font-medium border-b-2" data-tab="create">Buat Koin</button>
                    <button class="tab border-transparent py-2 px-3 md:px-4 text-sm font-medium border-b-2" data-tab="bot">Trading Bot</button>
                    <button class="tab border-transparent py-2 px-3 md:px-4 text-sm font-medium border-b-2" data-tab="withdraw">Tarik Saldo</button>
                </nav>
            </div>
        </div>

        <main>
            <div id="trade-tab" class="tab-content">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
                    <div class="lg:col-span-1 bg-gray-800 p-4 rounded-lg shadow-lg flex flex-col">
                        <div>
                            <h2 class="text-xl font-bold mb-2">Pasar</h2>
                            <!-- Adjusted max height for mobile -->
                            <div id="crypto-market-list" class="space-y-2 max-h-[40vh] md:max-h-[45vh] overflow-y-auto">
                            </div>
                        </div>
                        <div class="mt-4 pt-4 border-t border-gray-700 flex-grow">
                             <h3 class="text-lg font-semibold mb-2 text-center text-teal-400">Analisis Robot</h3>
                             <!-- Adjusted max height for mobile -->
                            <div id="robot-analysis-list" class="space-y-2 max-h-[20vh] md:max-h-[25vh] overflow-y-auto">
                                <p class="text-gray-500 text-center">Menjalankan analisis...</p>
                            </div>
                        </div>
                    </div>
                    <div class="lg:col-span-2 bg-gray-800 p-4 rounded-lg shadow-lg">
                        <div id="crypto-detail-placeholder" class="text-center text-gray-500 flex items-center justify-center h-full">
                            <p>Pilih koin dari daftar untuk melihat detail.</p>
                        </div>
                        <div id="crypto-detail-view" class="hidden">
                            <h2 id="crypto-name" class="text-2xl font-bold"></h2>
                            <p id="crypto-price" class="text-lg font-semibold mb-2"></p>
                            <div id="coin-stats" class="text-sm text-gray-400 mb-4 p-2 border-y border-gray-700">
                            </div>
                            <div class="h-48 md:h-64 mb-4"><canvas id="crypto-chart"></canvas></div>
                            <div class="border-b border-gray-700 mb-4">
                                <nav id="trade-type-nav" class="flex space-x-4">
                                    <button class="trade-tab active py-2 px-4 text-sm font-medium border-b-2" data-type="market">Market</button>
                                    <button class="trade-tab border-transparent py-2 px-4 text-sm font-medium text-gray-400 border-b-2 hover:text-white" data-type="limit">Limit</button>
                                </nav>
                            </div>
                            
                            <div id="market-order-panel">
                                 <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div class="space-y-4">
                                        <h3 class="text-lg font-semibold">Beli <span class="buy-title-ticker"></span></h3>
                                        <input type="number" id="buy-quantity" class="w-full bg-gray-700 p-3 rounded border border-gray-600 focus:outline-none focus:ring-2 focus:ring-orange-500" placeholder="Jumlah">
                                        <div class="flex justify-between space-x-1 mt-2">
                                            <button class="buy-percent-btn w-full bg-gray-600 hover:bg-gray-500 text-xs py-1 rounded" data-percent="0.25">25%</button>
                                            <button class="buy-percent-btn w-full bg-gray-600 hover:bg-gray-500 text-xs py-1 rounded" data-percent="0.50">50%</button>
                                            <button class="buy-percent-btn w-full bg-gray-600 hover:bg-gray-500 text-xs py-1 rounded" data-percent="0.75">75%</button>
                                            <button class="buy-percent-btn w-full bg-gray-600 hover:bg-gray-500 text-xs py-1 rounded" data-percent="1">Max</button>
                                        </div>
                                        <p class="text-sm text-gray-400">Total: <span id="buy-total">Rp 0</span></p>
                                        <button id="buy-button" class="w-full bg-green-600 hover:bg-green-700 font-bold py-3 px-4 rounded transition duration-200">Beli</button>
                                    </div>
                                    <div class="space-y-4">
                                         <h3 class="text-lg font-semibold">Jual <span class="sell-title-ticker"></span></h3>
                                         <p class="text-xs text-gray-400">Dimiliki: <span id="sell-owned-quantity">0</span></p>
                                        <input type="number" id="sell-quantity" class="w-full bg-gray-700 p-3 rounded border border-gray-600 focus:outline-none focus:ring-2 focus:ring-orange-500" placeholder="Jumlah">
                                        <div class="flex justify-between space-x-1 mt-2">
                                            <button class="sell-percent-btn w-full bg-gray-600 hover:bg-gray-500 text-xs py-1 rounded" data-percent="0.25">25%</button>
                                            <button class="sell-percent-btn w-full bg-gray-600 hover:bg-gray-500 text-xs py-1 rounded" data-percent="0.50">50%</button>
                                            <button class="sell-percent-btn w-full bg-gray-600 hover:bg-gray-500 text-xs py-1 rounded" data-percent="0.75">75%</button>
                                            <button class="sell-percent-btn w-full bg-gray-600 hover:bg-gray-500 text-xs py-1 rounded" data-percent="1">Max</button>
                                        </div>
                                        <p class="text-sm text-gray-400">Total: <span id="sell-total">Rp 0</span></p>
                                        <button id="sell-button" class="w-full bg-red-600 hover:bg-red-700 font-bold py-3 px-4 rounded transition duration-200">Jual</button>
                                    </div>
                                </div>
                            </div>
                            
                            <div id="limit-order-panel" class="hidden">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div class="space-y-4">
                                        <h3 class="text-lg font-semibold">Beli <span class="buy-title-ticker"></span> (Limit)</h3>
                                        <input type="number" id="limit-buy-price" class="w-full bg-gray-700 p-3 rounded border border-gray-600" placeholder="Harga">
                                        <input type="number" id="limit-buy-quantity" class="w-full bg-gray-700 p-3 rounded border border-gray-600" placeholder="Jumlah">
                                        <p class="text-sm text-gray-400">Total: <span id="limit-buy-total">Rp 0</span></p>
                                        <button id="limit-buy-button" class="w-full bg-green-600 hover:bg-green-700 font-bold py-3 px-4 rounded">Beli Limit</button>
                                    </div>
                                    <div class="space-y-4">
                                        <h3 class="text-lg font-semibold">Jual <span class="sell-title-ticker"></span> (Limit)</h3>
                                        <input type="number" id="limit-sell-price" class="w-full bg-gray-700 p-3 rounded border border-gray-600" placeholder="Harga">
                                        <input type="number" id="limit-sell-quantity" class="w-full bg-gray-700 p-3 rounded border border-gray-600" placeholder="Jumlah">
                                        <p class="text-sm text-gray-400">Total: <span id="limit-sell-total">Rp 0</span></p>
                                        <button id="limit-sell-button" class="w-full bg-red-600 hover:bg-red-700 font-bold py-3 px-4 rounded">Jual Limit</button>
                                    </div>
                                </div>
                            </div>

                            <div id="open-orders-section" class="mt-8">
                                <h3 class="text-xl font-bold mb-4">Order Terbuka</h3>
                                <div id="open-orders-list" class="space-y-2 max-h-48 overflow-y-auto">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Other Tabs remain largely the same as they are already mobile-friendly -->
             <div id="invest-tab" class="tab-content hidden">
                 <h2 class="text-2xl font-bold mb-4">Investasi (Staking)</h2>
                 <div id="staking-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                 </div>
            </div>
             <div id="create-tab" class="tab-content hidden">
                <h2 class="text-2xl font-bold mb-4">Buat Koin Kripto Baru</h2>
                <div class="border-b border-gray-700 mb-4">
                    <nav id="create-type-nav" class="flex space-x-2">
                        <button class="trade-tab active py-2 px-4 text-sm font-medium border-b-2" data-type="manual">Manual</button>
                        <button class="trade-tab border-transparent py-2 px-4 text-sm font-medium text-gray-400 border-b-2 hover:text-white" data-type="auto">Otomatis</button>
                    </nav>
                </div>

                <div id="create-manual-panel">
                    <div class="bg-gray-800 p-6 rounded-lg max-w-md mx-auto">
                        <div class="space-y-4">
                            <div>
                                <label class="text-sm">Nama Koin</label>
                                <input id="create-name" type="text" placeholder="Contoh: Koin Hebat" class="w-full bg-gray-700 p-2 rounded mt-1">
                            </div>
                             <div>
                                <label class="text-sm">Simbol Ticker (3-5 Huruf)</label>
                                <input id="create-ticker" type="text" placeholder="Contoh: KBH" maxlength="5" class="w-full bg-gray-700 p-2 rounded mt-1 uppercase">
                            </div>
                             <div>
                                <label class="text-sm">Pasokan Beredar (Distribusi ke Pasar)</label>
                                <input id="create-market-supply" type="number" placeholder="Jumlah yang langsung dijual di pasar" class="w-full bg-gray-700 p-2 rounded mt-1">
                            </div>
                             <div>
                                <label class="text-sm">Pasokan Cadangan (Untuk Developer/Mining)</label>
                                <input id="create-reserve-supply" type="number" placeholder="Jumlah yang dicadangkan" class="w-full bg-gray-700 p-2 rounded mt-1">
                            </div>
                             <div>
                                <label class="text-sm">Harga Awal (Rp)</label>
                                <input id="create-price" type="number" placeholder="Contoh: 100" class="w-full bg-gray-700 p-2 rounded mt-1">
                            </div>
                            <p class="text-sm text-gray-400">Biaya pembuatan: <span id="creation-cost">Rp 10,000,000</span></p>
                            <button id="create-coin-btn" class="w-full bg-orange-500 hover:bg-orange-600 font-bold py-3 px-4 rounded">Buat Koin Saya</button>
                        </div>
                    </div>
                </div>

                <div id="create-auto-panel" class="hidden">
                    <div class="bg-gray-800 p-6 rounded-lg max-w-md mx-auto">
                        <div class="space-y-4">
                             <div>
                                <label class="text-sm">Modal Investasi (Rp)</label>
                                <input id="create-auto-modal" type="number" placeholder="Contoh: 50000000" class="w-full bg-gray-700 p-2 rounded mt-1">
                                <p class="text-xs text-gray-400 mt-1">Modal ini akan digunakan untuk mendanai proyek dan menentukan skala koin Anda.</p>
                            </div>
                            <button id="create-coin-auto-btn" class="w-full bg-teal-500 hover:bg-teal-600 font-bold py-3 px-4 rounded">Buat Koin Otomatis</button>
                        </div>
                    </div>
                </div>
            </div>
             <div id="bot-tab" class="tab-content hidden">
                <h2 class="text-2xl font-bold mb-4">Smart Trading Robot</h2>
                <div class="bg-gray-800 p-6 rounded-lg max-w-2xl mx-auto grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="space-y-4">
                        <h3 class="text-lg font-semibold">Panel Kontrol</h3>
                        <div>
                            <label class="text-sm">Alokasi Saldo untuk Bot (Rp)</label>
                            <input id="bot-allocation" type="number" placeholder="0" class="w-full bg-gray-700 p-2 rounded mt-1">
                        </div>
                        <div class="flex justify-between space-x-1 mt-2" id="allocation-presets">
                            <button class="allocation-percent-btn w-full bg-gray-600 hover:bg-gray-500 text-xs py-1 rounded" data-percent="0">0%</button>
                            <button class="allocation-percent-btn w-full bg-gray-600 hover:bg-gray-500 text-xs py-1 rounded" data-percent="0.25">25%</button>
                            <button class="allocation-percent-btn w-full bg-gray-600 hover:bg-gray-500 text-xs py-1 rounded" data-percent="0.50">50%</button>
                            <button class="allocation-percent-btn w-full bg-gray-600 hover:bg-gray-500 text-xs py-1 rounded" data-percent="0.75">75%</button>
                            <button class="allocation-percent-btn w-full bg-gray-600 hover:bg-gray-500 text-xs py-1 rounded" data-percent="1">100%</button>
                        </div>
                        <button id="bot-set-allocation-btn" class="w-full bg-orange-500 hover:bg-orange-600 py-2 rounded">Alokasikan Dana</button>
                        <div class="grid grid-cols-2 gap-2">
                            <button id="bot-toggle-btn" class="w-full bg-green-600 hover:bg-green-700 py-2 rounded">Aktifkan Bot</button>
                            <button id="bot-withdraw-btn" class="w-full bg-gray-600 hover:bg-gray-700 py-2 rounded">Tarik Semua Dana</button>
                        </div>
                        <div class="bg-gray-700 p-3 rounded-lg text-sm space-y-2">
                             <p>Status: <span id="bot-status" class="font-bold text-red-400">Tidak Aktif</span></p>
                             <p>Total Aset Dikelola: <span id="bot-total-assets" class="font-bold text-cyan-400">Rp 0</span></p>
                             <p>Keuntungan/Kerugian (P/L): <span id="bot-pl" class="font-bold text-white">Rp 0</span></p>
                             <p>Winrate: <span id="bot-winrate" class="font-bold text-white">0%</span></p>
                        </div>
                        <div id="bot-benefits-panel" class="bg-gray-900 p-3 rounded-lg text-xs space-y-1">
                            <h4 class="font-bold text-sm text-center mb-1">Manfaat Bot</h4>
                            <p>Ukuran Transaksi: <span id="bot-trade-size" class="font-bold text-yellow-400">90%</span></p>
                            <p>Sensitivitas Sinyal: <span id="bot-signal-sensitivity" class="font-bold text-yellow-400">Ambang Sinyal: 0.0001</span></p>
                            <p>Koin Ekstra dari Perdagangan: <span id="bot-extra-coin" class="font-bold text-yellow-400">25%</span></p>
                            <p>Diskon Biaya Transaksi: <span id="bot-fee-discount" class="font-bold text-yellow-400">45%</span></p>
                            <p>Extra Cashback: <span id="bot-cashback" class="font-bold text-yellow-400">20%</span></p>
                        </div>
                    </div>
                    <div>
                        <h3 class="text-lg font-semibold mb-2">Log Transaksi</h3>
                        <div id="bot-log" class="bg-gray-900 p-3 rounded-lg h-80 overflow-y-auto space-y-2 text-xs">
                           <p class="text-gray-500">Belum ada aktivitas.</p>
                        </div>
                        <div class="mt-4">
                            <h3 class="text-lg font-semibold mb-2">Portofolio Bot</h3>
                            <div id="bot-portfolio" class="bg-gray-900 p-3 rounded-lg h-40 overflow-y-auto space-y-2 text-sm">
                                <p class="text-gray-500">Bot tidak memiliki aset.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
             <div id="withdraw-tab" class="tab-content hidden">
                 <h2 class="text-2xl font-bold mb-4">Tarik Saldo Tunai</h2>
                 <div class="bg-gray-800 p-6 rounded-lg max-w-md mx-auto">
                      <div class="space-y-4">
                          <div>
                            <p class="text-sm text-gray-400">Saldo Tersedia</p>
                            <p id="withdraw-available-balance" class="text-xl font-bold"></p>
                        </div>
                          <div>
                             <label class="text-sm">Jumlah Penarikan (Rp)</label>
                             <input id="withdraw-amount" type="number" placeholder="0" class="w-full bg-gray-700 p-2 rounded mt-1">
                        </div>
                        <div class="flex justify-between space-x-1 mt-2" id="withdraw-presets">
                            <button class="withdraw-percent-btn w-full bg-gray-600 hover:bg-gray-500 text-xs py-1 rounded" data-percent="0.25">25%</button>
                            <button class="withdraw-percent-btn w-full bg-gray-600 hover:bg-gray-500 text-xs py-1 rounded" data-percent="0.50">50%</button>
                            <button class="withdraw-percent-btn w-full bg-gray-600 hover:bg-gray-500 text-xs py-1 rounded" data-percent="0.75">75%</button>
                            <button class="withdraw-percent-btn w-full bg-gray-600 hover:bg-gray-500 text-xs py-1 rounded" data-percent="1">100%</button>
                        </div>
                        <button id="withdraw-btn" class="w-full bg-indigo-600 hover:bg-indigo-700 font-bold py-3 px-4 rounded">Tarik Dana</button>
                     </div>
                </div>
            </div>
        </main>

        <div class="mt-8 p-4 bg-gray-800 rounded-lg">
            <h3 class="text-lg font-semibold mb-2 text-center">Informasi Sufiks Angka</h3>
            <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-2 text-xs md:text-sm text-gray-400">
                <p><span class="font-bold text-white">Rb</span>: Ribu (10³)</p>
                <p><span class="font-bold text-white">Jt</span>: Juta (10⁶)</p>
                <p><span class="font-bold text-white">M</span>: Miliar (10⁹)</p>
                <p><span class="font-bold text-white">T</span>: Triliun (10¹²)</p>
                <p><span class="font-bold text-white">Ku</span>: Kuadriliun (10¹⁵)</p>
                <p><span class="font-bold text-white">Kn</span>: Kuintiliun (10¹⁸)</p>
                <p><span class="font-bold text-white">Sk</span>: Sekstiliun (10²¹)</p>
                <p><span class="font-bold text-white">Sp</span>: Septiliun (10²⁴)</p>
                <p><span class="font-bold text-white">Ok</span>: Oktiliun (10²⁷)</p>
                <p><span class="font-bold text-white">No</span>: Noniliun (10³⁰)</p>
                <p><span class="font-bold text-white">De</span>: Desiliun (10³³)</p>
                <p><span class="font-bold text-white">Ud</span>: Undesiliun (10³⁶)</p>
                <p><span class="font-bold text-white">Dd</span>: Duodesiliun (10³⁹)</p>
                <p><span class="font-bold text-white">Td</span>: Tredesiliun (10⁴²)</p>
                <p><span class="font-bold text-white">Kd</span>: Kuatuordesiliun (10⁴⁵)</p>
                <p><span class="font-bold text-white">Qd</span>: Kuindesiliun (10⁴⁸)</p>
                <p><span class="font-bold text-white">Sd</span>: Sekdesiliun (10⁵¹)</p>
                <p><span class="font-bold text-white">St</span>: Septendesiliun (10⁵⁴)</p>
                <p><span class="font-bold text-white">Od</span>: Oktodesiliun (10⁵⁷)</p>
                <p><span class="font-bold text-white">Nd</span>: Novemdesiliun (10⁶⁰)</p>
                <p><span class="font-bold text-white">Vg</span>: Vigintiliun (10⁶³)</p>
                <p><span class="font-bold text-white">Tg</span>: Trigintiliun (10⁹³)</p>
                <p><span class="font-bold text-white">Qg</span>: Kuadragintiliun (10¹²³)</p>
                <p><span class="font-bold text-white">Qqg</span>: Kuinkuagintiliun (10¹⁵³)</p>
            </div>
        </div>
    </div>

    <script>
        // --- DATA ---
        let cryptoData = {};
        let gameState = { 
            balance: 10000000, 
            portfolio: {}, 
            stakedAssets: {}, 
            createdCoins: {}, 
            marketPrices: {}, 
            limitOrders: [], 
            activeNews: [],
            bot: {
                isActive: false,
                allocatedBalance: 0,
                initialBalance: 0,
                holdings: {},
                trades: [],
                wins: 0,
                losses: 0
            }
        };
        let selectedCoin = null;
        let coinChart = null;

        // --- ELEMENT CACHING ---
        const balanceEl = document.getElementById('balance');
        const portfolioValueEl = document.getElementById('portfolio-value');
        const newsTickerEl = document.getElementById('news-ticker');
        
        function formatLargeNumber(num) {
            if (isNaN(num)) return '0';
            if (num < 1000) {
                if (num > 0 && num % 1 !== 0) {
                    return num.toLocaleString('id-ID', { maximumFractionDigits: 4 });
                }
                return num.toLocaleString('id-ID');
            }
        
            const suffixes = ['', ' Rb', ' Jt', ' M', ' T', ' Ku', ' Kn', ' Sk', ' Sp', ' Ok', ' No', ' De', ' Ud', ' Dd', ' Td', ' Kd', ' Qd', ' Sd', ' St', ' Od', ' Nd', 'Vg', 'UVg', 'DVg', 'TVg', 'QaVg', 'QiVg', 'SeVg', 'SpVg', 'OVg', 'NVg', 'Tg', 'UTg', 'DTg', 'TTg', 'QaTg', 'QiTg', 'SeTg', 'SpTg', 'OTg', 'NTg', 'Qg', 'UQg', 'DQg', 'TQg', 'QaQg', 'QiQg', 'SeQg', 'SpQg', 'OQg', 'Nqg', 'Qqg'];
            const i = Math.floor(Math.log10(num) / 3);
            
            if (i >= suffixes.length) {
                return num.toExponential(2).replace('e+', 'e');
            }
        
            let value = (num / Math.pow(1000, i));
            
            return value.toFixed(2).replace(/\.0+$/, '').replace(/\.$/, '') + suffixes[i];
        }

        function formatCurrency(num) {
            if (isNaN(num) || num === 0) return 'Rp 0';
            if (num > 0 && num < 10) {
                return `Rp ${num.toFixed(6)}`;
            }
             if (num >= 1000000) { // If it's a million or more, use the abbreviation.
                return `Rp ${formatLargeNumber(num)}`;
            }
            return `Rp ${Math.floor(num).toLocaleString('id-ID')}`;
        }
        
        // --- CORE FUNCTIONS ---
        function loadState() {
            const savedData = localStorage.getItem('cryptoExchangeData');
            const cleanState = { 
                balance: 10000000, 
                portfolio: {}, 
                stakedAssets: {}, 
                createdCoins: {}, 
                marketPrices: {}, 
                limitOrders: [], 
                activeNews: [], 
                bot: { isActive: false, allocatedBalance: 0, initialBalance: 0, holdings: {}, trades: [], wins: 0, losses: 0 }
            };
            
            if (savedData) {
                try {
                    const parsedData = JSON.parse(savedData);
                    gameState = { ...cleanState, ...parsedData, bot: { ...cleanState.bot, ...(parsedData.bot || {}) } };
                    
                    if (typeof gameState.balance !== 'number' || isNaN(gameState.balance)) {
                        console.warn('Saldo tidak valid terdeteksi dari data yang disimpan. Mereset saldo.');
                        gameState.balance = cleanState.balance;
                    }

                } catch(e) {
                    console.error("Gagal memuat data, kembali ke status awal.", e);
                    gameState = cleanState;
                }
            } else {
                gameState = cleanState;
            }
            
            cryptoData = {
                BTC: { name: "Bitcoin", basePrice: 1000000000, volatility: 0.5, totalSupply: 21000000, marketSupply: 19000000 },
                ETH: { name: "Ethereum", basePrice: 50000000, volatility: 0.6, totalSupply: 117500000, marketSupply: 100000000 },
                TST: { name: "TEST Coin", basePrice: 1000, volatility: 0.9, totalSupply: 1000000000, marketSupply: 500000000 },
                ...gameState.createdCoins
            };

            for(const id in cryptoData){
                if(!gameState.marketPrices[id] || !gameState.marketPrices[id].history){
                    gameState.marketPrices[id] = { 
                        price: cryptoData[id].basePrice, 
                        history: Array(50).fill(cryptoData[id].basePrice),
                        pressure: 0 
                    };
                }
            }
        }

        function saveState() {
            try {
                localStorage.setItem('cryptoExchangeData', JSON.stringify(gameState));
            } catch (e) {
                console.error("Gagal menyimpan data:", e);
            }
        }
        
        // --- RENDER FUNCTIONS ---
        function render() {
            try {
                const activeTab = document.querySelector('.tab.active').dataset.tab;
                if (activeTab === 'trade') renderTrade();
                else if (activeTab === 'invest') renderStaking();
                else if (activeTab === 'bot') renderBotTab();
                else if (activeTab === 'withdraw') renderWithdrawTab();
            } catch (e) {
                console.error("Error saat me-render tampilan utama:", e);
            }
        }

        function renderTrade() {
            renderCryptoList();
            renderRobotAnalysis();
            if(selectedCoin) renderCoinDetail();
        }

        function renderCryptoList() {
            const listEl = document.getElementById('crypto-market-list');
            listEl.innerHTML = Object.keys(cryptoData).map(id => {
                const market = gameState.marketPrices[id];
                if(!market) return '';
                const oldPrice = market.history[market.history.length - 2] || market.price;
                const change = market.price - oldPrice;
                const color = change >= 0 ? 'text-green-400' : 'text-red-400';
                
                const ownedQuantity = gameState.portfolio[id]?.quantity || 0;
                const marketValue = ownedQuantity * market.price;
                const marketValueHTML = ownedQuantity > 0 
                    ? `<p class="text-xs text-cyan-400">${formatCurrency(marketValue)}</p>` 
                    : '';

                return `
                <div class="crypto-item cursor-pointer p-2 rounded-md hover:bg-gray-700 flex justify-between" data-id="${id}">
                    <div>
                        <p class="font-bold">${id}</p>
                        <p class="text-xs text-gray-400">${cryptoData[id].name}</p>
                    </div>
                    <div class="text-right">
                        <p class="font-semibold ${color}">${formatCurrency(market.price)}</p>
                        ${marketValueHTML}
                    </div>
                </div>`;
            }).join('');
        }

        function renderCoinDetail() {
            if(!selectedCoin) return;
            document.getElementById('crypto-detail-placeholder').classList.add('hidden');
            document.getElementById('crypto-detail-view').classList.remove('hidden');
            
            document.getElementById('crypto-name').textContent = `${cryptoData[selectedCoin].name} (${selectedCoin})`;
            updateCoinDetailData();
            renderOpenOrders();
        }
        
        function updateCoinDetailData() {
            if(!selectedCoin || !gameState.marketPrices[selectedCoin]) return;
            document.getElementById('crypto-price').textContent = formatCurrency(gameState.marketPrices[selectedCoin].price);
            document.querySelectorAll('.buy-title-ticker').forEach(el => el.textContent = selectedCoin);
            document.querySelectorAll('.sell-title-ticker').forEach(el => el.textContent = selectedCoin);
            document.getElementById('sell-owned-quantity').textContent = formatLargeNumber(gameState.portfolio[selectedCoin]?.quantity || 0);
            
            const statsEl = document.getElementById('coin-stats');
            const coinInfo = cryptoData[selectedCoin];
            if (coinInfo && coinInfo.totalSupply) {
                const circulatingSupply = coinInfo.marketSupply || coinInfo.totalSupply;
                const marketPrice = gameState.marketPrices[selectedCoin]?.price || 0;
                const marketCap = circulatingSupply * marketPrice;
                statsEl.innerHTML = `
                    <div class="grid grid-cols-3 gap-2 text-center">
                        <div>
                            <p class="text-xs text-gray-500">Kapitalisasi Pasar</p>
                            <p>${formatCurrency(marketCap)}</p>
                        </div>
                        <div>
                            <p class="text-xs text-gray-500">Pasokan Beredar</p>
                            <p>${formatLargeNumber(circulatingSupply)}</p>
                        </div>
                        <div>
                            <p class="text-xs text-gray-500">Pasokan Total</p>
                            <p>${formatLargeNumber(coinInfo.totalSupply)}</p>
                        </div>
                    </div>
                `;
            } else {
                 statsEl.innerHTML = '';
            }
            
            updateEstimates();
        }

        function updateChart() {
            if (!selectedCoin || !gameState.marketPrices[selectedCoin]) return;
            const history = gameState.marketPrices[selectedCoin].history;
            const ctx = document.getElementById('crypto-chart').getContext('2d');
            
            if (history.length < 2) return;

            // Generate simulated OHLC data from price history
            const ohlcData = [];
            for (let i = 1; i < history.length; i++) {
                const open = history[i - 1];
                const close = history[i];
                // Add a small random variation to create wicks
                const high = Math.max(open, close) * (1 + Math.random() * 0.005);
                const low = Math.min(open, close) * (1 - Math.random() * 0.005);
                
                // Use milliseconds for the x-axis for time-series data
                ohlcData.push({
                    x: Date.now() - (history.length - i) * 2000, // Simulate time intervals
                    o: open,
                    h: high,
                    l: low,
                    c: close
                });
            }

            if (coinChart) {
                coinChart.destroy();
            }

            coinChart = new Chart(ctx, {
                type: 'candlestick',
                data: {
                    datasets: [{
                        label: `Harga ${selectedCoin}`,
                        data: ohlcData,
                        color: {
                            up: 'rgba(74, 222, 128, 1)',
                            down: 'rgba(248, 113, 113, 1)',
                            unchanged: 'rgba(156, 163, 175, 1)',
                        }
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            display: false, // Hide x-axis labels for a cleaner look
                            adapters: {
                                date: {
                                    locale: 'id',
                                },
                            },
                        },
                        y: {
                            ticks: {
                                color: '#9CA3AF'
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }
        
        function updateEstimates() {
            if(!selectedCoin || !gameState.marketPrices[selectedCoin]) return;
            const marketPrice = gameState.marketPrices[selectedCoin].price;
            
            const buyQty = parseFloat(document.getElementById('buy-quantity').value) || 0;
            document.getElementById('buy-total').textContent = formatCurrency(buyQty * marketPrice);
            const sellQty = parseFloat(document.getElementById('sell-quantity').value) || 0;
            document.getElementById('sell-total').textContent = formatCurrency(sellQty * marketPrice);

            const limitBuyPrice = parseFloat(document.getElementById('limit-buy-price').value) || 0;
            const limitBuyQty = parseFloat(document.getElementById('limit-buy-quantity').value) || 0;
            document.getElementById('limit-buy-total').textContent = formatCurrency(limitBuyQty * limitBuyPrice);
            const limitSellPrice = parseFloat(document.getElementById('limit-sell-price').value) || 0;
            const limitSellQty = parseFloat(document.getElementById('limit-sell-quantity').value) || 0;
            document.getElementById('limit-sell-total').textContent = formatCurrency(limitSellQty * limitSellPrice);
        }
        
        function renderStaking() {
            const container = document.getElementById('staking-container');
            let hasStakableAssets = false;
            const content = Object.keys(cryptoData).map(id => {
                 const owned = gameState.portfolio[id]?.quantity || 0;
                 const staked = gameState.stakedAssets[id] || { amount: 0, reward: 0 };
                 
                 if(owned === 0 && staked.amount === 0) return '';
                 
                 hasStakableAssets = true;
                 const APY = 10 + (id.length % 5);
                 const marketPrice = gameState.marketPrices[id]?.price || 0;
                 const marketValue = (owned + staked.amount) * marketPrice;

                 return `
                 <div class="bg-gray-800 p-4 rounded-lg" id="staking-card-${id}">
                     <h3 class="font-bold text-lg">${cryptoData[id].name} (${id})</h3>
                     <p class="text-sm text-green-400">APY: ${APY}%</p>
                     <div class="mt-2 text-sm">
                         <p>Total Aset: <span class="staking-total-asset">${formatLargeNumber(owned + staked.amount)}</span></p>
                         <p class="font-semibold">Nilai Pasar: <span class="staking-market-value text-cyan-400">${formatCurrency(marketValue)}</span></p>
                         <hr class="my-2 border-gray-600">
                         <p>Dompet: <span class="staking-owned">${formatLargeNumber(owned)}</span></p>
                         <p>Distake: <span class="staking-staked">${formatLargeNumber(staked.amount)}</span></p>
                         <p>Hadiah: <span class="staking-reward text-yellow-400">${staked.reward.toFixed(6)}</span> ${id}</p>
                     </div>
                     <div class="mt-4 space-y-2">
                         <input type="number" class="stake-amount w-full bg-gray-700 p-2 rounded" placeholder="Jumlah stake" data-id="${id}">
                         <div class="grid grid-cols-2 gap-2">
                             <button class="stake-btn w-full bg-blue-600 hover:bg-blue-700 py-2 rounded" data-id="${id}">Stake</button>
                             <button class="stake-all-btn w-full bg-sky-600 hover:bg-sky-700 py-2 rounded" data-id="${id}">Stake Semua</button>
                         </div>
                         <button class="unstake-btn w-full bg-gray-600 hover:bg-gray-700 py-2 rounded" data-id="${id}">Unstake Semua</button>
                         <button class="claim-btn w-full bg-yellow-500 hover:bg-yellow-600 py-2 rounded" data-id="${id}">Klaim Hadiah</button>
                     </div>
                 </div>
                 `;
            }).join('');

            if (!hasStakableAssets) {
                container.innerHTML = '<p class="text-gray-500 col-span-full">Beli koin di menu Perdagangan untuk mulai staking.</p>';
            } else {
                 container.innerHTML = content;
            }
        }

        function renderBotTab() {
            const bot = gameState.bot;
            const statusEl = document.getElementById('bot-status');
            const toggleBtn = document.getElementById('bot-toggle-btn');
            const allocationInput = document.getElementById('bot-allocation');
            const withdrawBtn = document.getElementById('bot-withdraw-btn');
            const botPortfolioEl = document.getElementById('bot-portfolio');

            allocationInput.value = bot.initialBalance;
            allocationInput.disabled = bot.isActive;
            document.getElementById('bot-set-allocation-btn').disabled = bot.isActive;
            withdrawBtn.disabled = bot.isActive;

            if (bot.isActive) {
                statusEl.textContent = 'Aktif';
                statusEl.classList.remove('text-red-400');
                statusEl.classList.add('text-green-400');
                toggleBtn.textContent = 'Nonaktifkan Bot';
                toggleBtn.classList.remove('bg-green-600', 'hover:bg-green-700');
                toggleBtn.classList.add('bg-red-600', 'hover:bg-red-700');
            } else {
                statusEl.textContent = 'Tidak Aktif';
                statusEl.classList.add('text-red-400');
                statusEl.classList.remove('text-green-400');
                toggleBtn.textContent = 'Aktifkan Bot';
                toggleBtn.classList.add('bg-green-600', 'hover:bg-green-700');
                toggleBtn.classList.remove('bg-red-600', 'hover:bg-red-700');
            }

            const holdingsValue = Object.keys(bot.holdings).reduce((sum, id) => {
                const holding = bot.holdings[id];
                const price = gameState.marketPrices[id]?.price || 0;
                return sum + (holding.quantity * price);
            }, 0);

            const totalAssets = bot.allocatedBalance + holdingsValue;
            const profitLoss = totalAssets - bot.initialBalance;
            
            document.getElementById('bot-total-assets').textContent = formatCurrency(totalAssets);
            const plEl = document.getElementById('bot-pl');
            plEl.textContent = formatCurrency(profitLoss);
            plEl.className = 'font-bold ';
            if (profitLoss > 0) plEl.classList.add('text-green-400');
            else if (profitLoss < 0) plEl.classList.add('text-red-400');
            else plEl.classList.add('text-white');

            const totalTrades = bot.wins + bot.losses;
            const winrate = totalTrades > 0 ? (bot.wins / totalTrades) * 100 : 0;
            document.getElementById('bot-winrate').textContent = `${winrate.toFixed(2)}%`;

            const logEl = document.getElementById('bot-log');
            if (bot.trades.length === 0) {
                 logEl.innerHTML = '<p class="text-gray-500">Belum ada aktivitas.</p>';
            } else {
                logEl.innerHTML = bot.trades.slice().reverse().map(trade => {
                    const color = trade.type === 'BELI' ? 'text-green-400' : 'text-red-400';
                    return `<p><span class="${color}">${trade.type}</span> ${formatLargeNumber(trade.quantity)} ${trade.coinId} @ ${formatCurrency(trade.price)}</p>`;
                }).join('');
            }
            
            // Render Bot Portfolio
            const botHoldings = Object.keys(bot.holdings);
            if (botHoldings.length === 0) {
                 botPortfolioEl.innerHTML = '<p class="text-gray-500">Bot tidak memiliki aset.</p>';
            } else {
                botPortfolioEl.innerHTML = botHoldings.map(id => {
                    const holding = bot.holdings[id];
                    const price = gameState.marketPrices[id]?.price || 0;
                    const marketValue = holding.quantity * price;
                    return `
                        <div class="flex justify-between items-center">
                            <span class="font-bold">${id}</span>
                            <span>
                                <span class="text-gray-400">Jml:</span> ${formatLargeNumber(holding.quantity)}
                            </span>
                            <span>
                                <span class="text-gray-400">Nilai:</span> ${formatCurrency(marketValue)}
                            </span>
                        </div>
                    `;
                }).join('');
            }
        }
        
        function renderWithdrawTab() {
            document.getElementById('withdraw-available-balance').textContent = formatCurrency(gameState.balance);
        }

        function renderOpenOrders() {
            const listEl = document.getElementById('open-orders-list');
            const openOrders = gameState.limitOrders.filter(order => order.status === 'open');
            if (openOrders.length === 0) {
                listEl.innerHTML = `<p class="text-gray-500">Tidak ada order terbuka.</p>`;
                return;
            }
            listEl.innerHTML = openOrders.map(order => `
                <div class="bg-gray-700 p-2 rounded-md flex justify-between items-center text-sm">
                    <div>
                        <span class="font-bold ${order.type === 'buy' ? 'text-green-400' : 'text-red-400'}">${order.type.toUpperCase()} ${order.coinId}</span>
                        <span class="text-gray-400 ml-2">Jml: ${formatLargeNumber(order.quantity)} @ ${formatCurrency(order.price)}</span>
                    </div>
                    <button class="cancel-order-btn text-xs bg-gray-600 hover:bg-red-700 px-2 py-1 rounded" data-id="${order.id}">Batal</button>
                </div>
            `).join('');
        }
        
        function updateStakingData() {
            Object.keys(cryptoData).forEach(id => {
                const card = document.getElementById(`staking-card-${id}`);
                if (!card) return; 

                const owned = gameState.portfolio[id]?.quantity || 0;
                const staked = gameState.stakedAssets[id] || { amount: 0, reward: 0 };
                const marketPrice = gameState.marketPrices[id]?.price || 0;
                const marketValue = (owned + staked.amount) * marketPrice;

                card.querySelector('.staking-total-asset').textContent = formatLargeNumber(owned + staked.amount);
                card.querySelector('.staking-market-value').textContent = formatCurrency(marketValue);
                card.querySelector('.staking-owned').textContent = formatLargeNumber(owned);
                card.querySelector('.staking-staked').textContent = formatLargeNumber(staked.amount);
                card.querySelector('.staking-reward').textContent = staked.reward.toFixed(6);
            });
        }

        function renderNewsTicker() {
            let newsText;
            if (gameState.activeNews.length > 0) {
                newsText = gameState.activeNews.map(news => news.text).join('  •  ');
            } else {
                newsText = "Tidak ada berita pasar terbaru.";
            }
            
            const fullText = newsText + '  •  ' + newsText + '  •  '; // Duplicate for seamless effect
            const tickerSpan = newsTickerEl.querySelector('span');
            tickerSpan.textContent = fullText;

            const duration = fullText.length * 0.15; // Adjust speed: 0.15 seconds per character
            tickerSpan.style.animation = 'none'; // Reset animation
            tickerSpan.offsetHeight; /* trigger reflow */
            tickerSpan.style.animation = `marquee-scroll ${duration}s linear infinite`;
        }
        
        function renderRobotAnalysis() {
            const analysisListEl = document.getElementById('robot-analysis-list');
            let analysisHTML = '';
            
            const SHORT_PERIOD = 5;
            const LONG_PERIOD = 20;

            for (const id in cryptoData) {
                const history = gameState.marketPrices[id].history;
                if (history.length < LONG_PERIOD) continue;

                const shortSMA = history.slice(-SHORT_PERIOD).reduce((a, b) => a + b, 0) / SHORT_PERIOD;
                const longSMA = history.slice(-LONG_PERIOD).reduce((a, b) => a + b, 0) / LONG_PERIOD;
                
                const lastShortSMA = history.slice(-SHORT_PERIOD - 1, -1).reduce((a, b) => a + b, 0) / SHORT_PERIOD;
                const lastLongSMA = history.slice(-LONG_PERIOD - 1, -1).reduce((a, b) => a + b, 0) / LONG_PERIOD;

                let signal = null;
                let entryPrice = 0;
                let targetPrice = 0;
                const currentPrice = gameState.marketPrices[id].price;

                // Golden Cross (Buy Signal)
                if (lastShortSMA <= lastLongSMA && shortSMA > longSMA) {
                    signal = 'BELI';
                    entryPrice = currentPrice;
                    targetPrice = currentPrice * 1.05; // 5% profit target
                } 
                // Death Cross (Sell Signal)
                else if (lastShortSMA >= lastLongSMA && shortSMA < longSMA) {
                    signal = 'JUAL';
                    entryPrice = currentPrice;
                    targetPrice = currentPrice * 0.95; // 5% stop-loss/profit target
                }

                if (signal) {
                    const signalColor = signal === 'BELI' ? 'text-green-400' : 'text-red-400';
                    analysisHTML += `
                        <div class="grid grid-cols-4 gap-2 text-xs p-1 bg-gray-900 rounded">
                            <span class="font-bold">${id}</span>
                            <span class="font-semibold ${signalColor}">${signal}</span>
                            <span>${formatCurrency(entryPrice)}</span>
                            <span>${formatCurrency(targetPrice)}</span>
                        </div>
                    `;
                }
            }

            if (analysisHTML === '') {
                analysisListEl.innerHTML = '<p class="text-gray-500 text-center text-xs">Tidak ada sinyal trading yang jelas saat ini.</p>';
            } else {
                const headerHTML = `
                    <div class="grid grid-cols-4 gap-2 text-xs font-bold text-gray-400 border-b border-gray-700 pb-1 mb-2">
                        <span>Koin</span>
                        <span>Sinyal</span>
                        <span>Harga Entri</span>
                        <span>Target Tutup</span>
                    </div>
                `;
                analysisListEl.innerHTML = headerHTML + analysisHTML;
            }
        }

        function updateDynamicData() {
            balanceEl.textContent = formatCurrency(gameState.balance);
            const portfolioValue = Object.keys(gameState.portfolio).reduce((sum, id) => (gameState.portfolio[id].quantity * (gameState.marketPrices[id]?.price || 0)), 0);
            const stakedValue = Object.keys(gameState.stakedAssets).reduce((sum, id) => (gameState.stakedAssets[id].amount * (gameState.marketPrices[id]?.price || 0)), 0);
            portfolioValueEl.textContent = formatCurrency(portfolioValue + stakedValue);
            
            renderNewsTicker();

            const activeTab = document.querySelector('.tab.active').dataset.tab;
            if (activeTab === 'trade') {
                if (selectedCoin) updateCoinDetailData();
                renderCryptoList();
                renderRobotAnalysis();
            } else if (activeTab === 'invest') {
                updateStakingData();
            } else if (activeTab === 'bot') {
                renderBotTab();
            } else if (activeTab === 'withdraw') {
                renderWithdrawTab();
            }
        }

        function processLimitOrders() {
            gameState.limitOrders.forEach(order => {
                if (order.status !== 'open') return;
                const marketPrice = gameState.marketPrices[order.coinId]?.price;
                if (!marketPrice) return;

                let executed = false;
                if (order.type === 'buy' && marketPrice <= order.price) {
                    const holding = gameState.portfolio[order.coinId] || { quantity: 0, avgPrice: 0 };
                    const totalCost = (holding.quantity * holding.avgPrice) + order.cost;
                    holding.quantity += order.quantity;
                    holding.avgPrice = totalCost / holding.quantity;
                    gameState.portfolio[order.coinId] = holding;
                    executed = true;
                } else if (order.type === 'sell' && marketPrice >= order.price) {
                    gameState.balance += order.quantity * order.price; 
                    executed = true;
                }

                if (executed) {
                    order.status = 'filled';
                }
            });
             gameState.limitOrders = gameState.limitOrders.filter(order => order.status === 'open');
             if(selectedCoin) renderOpenOrders();
        }

        // --- EVENT LISTENERS & HANDLERS ---
        document.querySelector('.container').addEventListener('click', (e) => {
            const tab = e.target.closest('.tab');
            if (tab) {
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
                tab.classList.add('active');
                document.getElementById(`${tab.dataset.tab}-tab`).classList.remove('hidden');
                
                selectedCoin = null;
                document.getElementById('crypto-detail-placeholder').classList.remove('hidden');
                document.getElementById('crypto-detail-view').classList.add('hidden');

                render();
            }
            const cryptoItem = e.target.closest('.crypto-item');
            if (cryptoItem) {
                selectedCoin = cryptoItem.dataset.id;
                renderCoinDetail();
                updateChart();
            }
            const cancelBtn = e.target.closest('.cancel-order-btn');
            if (cancelBtn) {
                const orderId = cancelBtn.dataset.id;
                cancelLimitOrder(orderId);
            }
        });

        document.getElementById('trade-tab').addEventListener('click', e => {
            const buyPercentBtn = e.target.closest('.buy-percent-btn');
            if (buyPercentBtn) {
                if (!selectedCoin) return;
                const percent = parseFloat(buyPercentBtn.dataset.percent);
                const price = gameState.marketPrices[selectedCoin].price;
                if (price > 0) {
                    const quantity = (gameState.balance * percent) / price;
                    document.getElementById('buy-quantity').value = quantity.toFixed(8);
                    updateEstimates();
                }
            }

            const sellPercentBtn = e.target.closest('.sell-percent-btn');
            if (sellPercentBtn) {
                if (!selectedCoin) return;
                const percent = parseFloat(sellPercentBtn.dataset.percent);
                const ownedQuantity = gameState.portfolio[selectedCoin]?.quantity || 0;
                const quantity = ownedQuantity * percent;
                document.getElementById('sell-quantity').value = quantity.toFixed(8);
                updateEstimates();
            }
        });

        document.getElementById('trade-type-nav').addEventListener('click', e => {
            const button = e.target.closest('.trade-tab');
            if (!button) return;
            
            document.querySelectorAll('.trade-tab').forEach(btn => {
                btn.classList.remove('active', 'border-orange-500', 'text-white');
                btn.classList.add('border-transparent', 'text-gray-400');
            });
            button.classList.add('active', 'border-orange-500', 'text-white');
            button.classList.remove('border-transparent', 'text-gray-400');

            const type = button.dataset.type;
            document.getElementById('market-order-panel').classList.toggle('hidden', type !== 'market');
            document.getElementById('limit-order-panel').classList.toggle('hidden', type !== 'limit');
        });
        
        document.getElementById('create-type-nav').addEventListener('click', e => {
            const button = e.target.closest('.trade-tab');
            if (!button) return;
            
            document.querySelectorAll('#create-type-nav .trade-tab').forEach(btn => {
                btn.classList.remove('active', 'border-orange-500', 'text-white');
                btn.classList.add('border-transparent', 'text-gray-400');
            });
            button.classList.add('active', 'border-orange-500', 'text-white');
            button.classList.remove('border-transparent', 'text-gray-400');

            const type = button.dataset.type;
            document.getElementById('create-manual-panel').classList.toggle('hidden', type !== 'manual');
            document.getElementById('create-auto-panel').classList.toggle('hidden', type !== 'auto');
        });

        document.getElementById('create-coin-btn').addEventListener('click', () => {
            const name = document.getElementById('create-name').value.trim();
            const ticker = document.getElementById('create-ticker').value.trim().toUpperCase();
            const marketSupply = parseFloat(document.getElementById('create-market-supply').value);
            const reserveSupply = parseFloat(document.getElementById('create-reserve-supply').value) || 0;
            const price = parseFloat(document.getElementById('create-price').value);
            const cost = 10000000;

            if (!name || !ticker || isNaN(marketSupply) || !price || ticker.length < 3 || marketSupply <= 0) {
                return alert('Harap isi semua kolom dengan benar. Pasokan Beredar harus lebih dari 0.');
            }
            if (gameState.balance < cost) return alert('Saldo tidak cukup untuk membuat koin.');
            if (cryptoData[ticker]) return alert('Simbol Ticker sudah ada.');

            const totalSupply = marketSupply + reserveSupply;

            gameState.balance -= cost;
            gameState.createdCoins[ticker] = { name, basePrice: price, volatility: 0.8 + (Math.random() * 0.4), totalSupply: totalSupply, marketSupply: marketSupply };
            const portfolio = gameState.portfolio[ticker] || { quantity: 0, avgPrice: 0};
            portfolio.quantity += reserveSupply;
            gameState.portfolio[ticker] = portfolio;
            
            cryptoData[ticker] = gameState.createdCoins[ticker];
            gameState.marketPrices[ticker] = { price: price, history: Array(50).fill(price), pressure: 0 };

            alert(`Selamat! Koin ${name} (${ticker}) berhasil dibuat!`);

            document.getElementById('create-name').value = '';
            document.getElementById('create-ticker').value = '';
            document.getElementById('create-market-supply').value = '';
            document.getElementById('create-reserve-supply').value = '';
            document.getElementById('create-price').value = '';
            saveState();

            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelector('.tab[data-tab="trade"]').classList.add('active');
            document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
            document.getElementById('trade-tab').classList.remove('hidden');

            selectedCoin = ticker;
            render();
            updateChart();
        });

         document.getElementById('create-coin-auto-btn').addEventListener('click', () => {
            const modal = parseFloat(document.getElementById('create-auto-modal').value);

            if (isNaN(modal) || modal <= 0) {
                return alert('Harap masukkan jumlah modal yang valid.');
            }
            if (gameState.balance < modal) return alert('Saldo tidak cukup untuk investasi ini.');

            function generateUniqueTicker() {
                const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
                let newTicker;
                do {
                    newTicker = '';
                    for (let i = 0; i < 4; i++) {
                        newTicker += chars.charAt(Math.floor(Math.random() * chars.length));
                    }
                } while (cryptoData[newTicker]);
                return newTicker;
            }

            function generateRandomName() {
                const prefixes = ["Quantum", "Apex", "Stellar", "Orion", "Cyber", "Nexus", "Zenith", "Eon"];
                const suffixes = ["Chain", "Link", "Coin", "Net", "Protocol", "Digital", "Ledger", "Core"];
                return `${prefixes[Math.floor(Math.random() * prefixes.length)]} ${suffixes[Math.floor(Math.random() * suffixes.length)]}`;
            }

            const ticker = generateUniqueTicker();
            const name = generateRandomName();
            const totalSupply = modal * (10 + Math.random() * 90);
            const marketSupplyRatio = 0.5 + Math.random() * 0.4;
            const marketSupply = totalSupply * marketSupplyRatio;
            const reserveSupply = totalSupply - marketSupply;
            const price = modal / marketSupply;
            const volatility = 0.6 + Math.random() * 0.6;
            
            gameState.balance -= modal;
            gameState.createdCoins[ticker] = { name, basePrice: price, volatility, totalSupply, marketSupply };
            const portfolio = gameState.portfolio[ticker] || { quantity: 0, avgPrice: 0};
            portfolio.quantity += reserveSupply;
            gameState.portfolio[ticker] = portfolio;
            
            cryptoData[ticker] = gameState.createdCoins[ticker];
            gameState.marketPrices[ticker] = { price: price, history: Array(50).fill(price), pressure: 0 };

            alert(`Selamat! Proyek baru ${name} (${ticker}) berhasil didanai!`);
            document.getElementById('create-auto-modal').value = '';
            saveState();

            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelector('.tab[data-tab="trade"]').classList.add('active');
            document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
            document.getElementById('trade-tab').classList.remove('hidden');

            selectedCoin = ticker;
            render();
            updateChart();
        });

        document.getElementById('reset-button').addEventListener('click', () => {
            localStorage.removeItem('cryptoExchangeData');
            location.reload();
        });

        function handleMarketTrade(type) {
            if (!selectedCoin) return;
            const price = gameState.marketPrices[selectedCoin].price;
            const inputEl = document.getElementById(`${type}-quantity`);
            const quantity = parseFloat(inputEl.value);

            if (isNaN(quantity) || quantity <= 0) return;
            
            const coin = cryptoData[selectedCoin];
            const market = gameState.marketPrices[selectedCoin];

            if (type === 'buy') {
                const cost = quantity * price;
                if (gameState.balance < cost) return alert('Saldo tidak cukup.');
                if (coin.marketSupply + quantity > coin.totalSupply) return alert('Pasokan koin tidak mencukupi untuk dibeli.');

                gameState.balance -= cost;
                const holding = gameState.portfolio[selectedCoin] || { quantity: 0, avgPrice: 0 };
                const totalCost = (holding.quantity * holding.avgPrice) + cost;
                holding.quantity += quantity;
                holding.avgPrice = totalCost / holding.quantity;
                gameState.portfolio[selectedCoin] = holding;
                
                coin.marketSupply += quantity;
                market.pressure += quantity / coin.marketSupply * 50; 
            } else { // sell
                const holding = gameState.portfolio[selectedCoin];
                if (!holding || holding.quantity < quantity) return alert('Koin tidak cukup.');

                gameState.balance += quantity * price;
                holding.quantity -= quantity;
                if(holding.quantity < 1e-9) delete gameState.portfolio[selectedCoin];
                
                coin.marketSupply -= quantity;
                market.pressure -= quantity / coin.marketSupply * 50;
            }
            inputEl.value = '';
            saveState();
            updateCoinDetailData();
        }

        function handleLimitTrade(type) {
            if (!selectedCoin) return;
            const price = parseFloat(document.getElementById(`limit-${type}-price`).value);
            const quantity = parseFloat(document.getElementById(`limit-${type}-quantity`).value);

            if (isNaN(price) || isNaN(quantity) || price <= 0 || quantity <= 0) return alert('Harga dan jumlah harus valid.');

            if (type === 'buy') {
                const cost = price * quantity;
                if (gameState.balance < cost) return alert('Saldo tidak cukup untuk order ini.');
                gameState.balance -= cost;
                gameState.limitOrders.push({ id: Date.now().toString(), coinId: selectedCoin, type: 'buy', price, quantity, cost, status: 'open' });
            } else { // sell
                const holding = gameState.portfolio[selectedCoin];
                if (!holding || holding.quantity < quantity) return alert('Koin tidak cukup untuk dijual.');
                holding.quantity -= quantity;
                gameState.limitOrders.push({ id: Date.now().toString(), coinId: selectedCoin, type: 'sell', price, quantity, status: 'open' });
            }
            
            saveState();
            renderOpenOrders();
            document.getElementById(`limit-${type}-price`).value = '';
            document.getElementById(`limit-${type}-quantity`).value = '';
            updateEstimates();
        }

        function cancelLimitOrder(orderId) {
            const orderIndex = gameState.limitOrders.findIndex(o => o.id === orderId);
            if (orderIndex === -1) return;
            
            const order = gameState.limitOrders[orderIndex];
            if (order.type === 'buy') {
                gameState.balance += order.cost;
            } else { // sell
                const holding = gameState.portfolio[order.coinId] || { quantity: 0 };
                holding.quantity += order.quantity;
                gameState.portfolio[order.coinId] = holding;
            }
            
            gameState.limitOrders.splice(orderIndex, 1);
            saveState();
            renderOpenOrders();
        }
        
        document.getElementById('buy-button').addEventListener('click', () => handleMarketTrade('buy'));
        document.getElementById('sell-button').addEventListener('click', () => handleMarketTrade('sell'));
        ['buy-quantity', 'sell-quantity', 'limit-buy-price', 'limit-buy-quantity', 'limit-sell-price', 'limit-sell-quantity'].forEach(id => {
            document.getElementById(id).addEventListener('input', updateEstimates);
        });
        document.getElementById('limit-buy-button').addEventListener('click', () => handleLimitTrade('buy'));
        document.getElementById('limit-sell-button').addEventListener('click', () => handleLimitTrade('sell'));

        document.getElementById('invest-tab').addEventListener('click', e => {
            const id = e.target.dataset.id;
            if (!id) return;
            
            const portfolio = gameState.portfolio[id] || { quantity: 0 };
            const staked = gameState.stakedAssets[id] || { amount: 0, reward: 0 };

            if(e.target.classList.contains('stake-btn')){
                const card = document.getElementById(`staking-card-${id}`);
                const input = card.querySelector('.stake-amount');
                const amount = parseFloat(input.value);
                if (isNaN(amount) || amount <= 0) return alert("Jumlah tidak valid.");
                if (amount > portfolio.quantity) return alert("Jumlah stake melebihi aset di dompet.");
                
                portfolio.quantity -= amount;
                staked.amount += amount;
                gameState.portfolio[id] = portfolio;
                gameState.stakedAssets[id] = staked;
                input.value = '';
            } else if(e.target.classList.contains('stake-all-btn')) {
                const amountToStakeAll = portfolio.quantity;
                if (isNaN(amountToStakeAll) || amountToStakeAll <= 0) return;

                portfolio.quantity = 0;
                staked.amount += amountToStakeAll;
                gameState.portfolio[id] = portfolio;
                gameState.stakedAssets[id] = staked;
            } else if (e.target.classList.contains('unstake-btn')) {
                if (staked.amount <= 0) return;
                portfolio.quantity += staked.amount;
                staked.amount = 0;
                gameState.portfolio[id] = portfolio;
                gameState.stakedAssets[id] = staked;
            } else if (e.target.classList.contains('claim-btn')) {
                 if (staked.reward <= 0) return;
                 portfolio.quantity += staked.reward;
                 staked.reward = 0;
                 gameState.portfolio[id] = portfolio;
                 gameState.stakedAssets[id] = staked;
            }
            
            saveState();
            renderStaking();
        });

        // --- Bot Listeners ---
        document.getElementById('bot-set-allocation-btn').addEventListener('click', () => {
            const amount = parseFloat(document.getElementById('bot-allocation').value);
            if (isNaN(amount) || amount < 0) return alert('Jumlah alokasi tidak valid.');
            if (amount > gameState.balance) return alert('Saldo tidak cukup.');

            gameState.balance -= amount;
            gameState.bot.allocatedBalance += amount;
            gameState.bot.initialBalance += amount;
            renderBotTab();
            saveState();
        });

        document.getElementById('bot-toggle-btn').addEventListener('click', () => {
            if (gameState.bot.initialBalance <= 0 && !gameState.bot.isActive) {
                return alert('Alokasikan dana terlebih dahulu sebelum mengaktifkan bot.');
            }
            gameState.bot.isActive = !gameState.bot.isActive;
            renderBotTab();
            saveState();
        });

        document.getElementById('allocation-presets').addEventListener('click', (e) => {
            const target = e.target.closest('.allocation-percent-btn');
            if (!target) return;

            const percent = parseFloat(target.dataset.percent);
            const allocationAmount = Math.floor(gameState.balance * percent);
            document.getElementById('bot-allocation').value = allocationAmount;
        });

        document.getElementById('bot-withdraw-btn').addEventListener('click', () => {
            if (gameState.bot.isActive) {
                return alert('Nonaktifkan bot terlebih dahulu untuk menarik dana.');
            }

            const holdingsValue = Object.keys(gameState.bot.holdings).reduce((sum, id) => {
                const holding = bot.holdings[id];
                const price = gameState.marketPrices[id]?.price || 0;
                return sum + (holding.quantity * price);
            }, 0);

            const totalWithdrawal = gameState.bot.allocatedBalance + holdingsValue;
            gameState.balance += totalWithdrawal;

            // Reset bot state
            gameState.bot.allocatedBalance = 0;
            gameState.bot.initialBalance = 0;
            gameState.bot.holdings = {};
            gameState.bot.trades = [];
            
            renderBotTab();
            saveState();
        });
        
        // --- Withdraw Listeners ---
        document.getElementById('withdraw-presets').addEventListener('click', (e) => {
             const target = e.target.closest('.withdraw-percent-btn');
            if (!target) return;

            const percent = parseFloat(target.dataset.percent);
            const withdrawAmount = Math.floor(gameState.balance * percent);
            document.getElementById('withdraw-amount').value = withdrawAmount;
        });

        document.getElementById('withdraw-btn').addEventListener('click', () => {
            const amount = parseFloat(document.getElementById('withdraw-amount').value);
            if(isNaN(amount) || amount <= 0) {
                return alert('Jumlah penarikan tidak valid.');
            }
            if(amount > gameState.balance) {
                return alert('Saldo tidak mencukupi.');
            }

            gameState.balance -= amount;
            
            // Communicate withdrawal to Idle Tycoon Game
            const tycoonWithdrawal = parseFloat(localStorage.getItem('tycoonWithdrawal') || '0');
            localStorage.setItem('tycoonWithdrawal', tycoonWithdrawal + amount);

            alert(`Dana sebesar ${formatCurrency(amount)} berhasil ditarik dan dikembalikan ke Idle Tycoon.`);
            document.getElementById('withdraw-amount').value = '';
            renderWithdrawTab();
            saveState();
        });


        // --- MARKET SIMULATION & GAME LOOP ---
        function getBotFee() {
            const baseFee = 0.001; // 0.1% base fee
            const discount = 0.45; // 45% fixed discount
            return baseFee * (1 - discount);
        }

        function runTradingBot() {
            if (!gameState.bot.isActive) return;

            const SHORT_PERIOD = 5;
            const LONG_PERIOD = 20;

            for (const id in cryptoData) {
                const history = gameState.marketPrices[id].history;
                if (history.length < LONG_PERIOD) continue;

                const shortSMA = history.slice(-SHORT_PERIOD).reduce((a, b) => a + b, 0) / SHORT_PERIOD;
                const longSMA = history.slice(-LONG_PERIOD).reduce((a, b) => a + b, 0) / LONG_PERIOD;
                
                const lastShortSMA = history.slice(-SHORT_PERIOD - 1, -1).reduce((a, b) => a + b, 0) / SHORT_PERIOD;
                const lastLongSMA = history.slice(-LONG_PERIOD - 1, -1).reduce((a, b) => a + b, 0) / LONG_PERIOD;
                
                const price = gameState.marketPrices[id].price;
                const botHolding = gameState.bot.holdings[id];

                const tradePercentage = 0.90; // 90%
                const skillThreshold = 0.0001;
                const signalStrength = Math.abs(shortSMA - longSMA) / longSMA;

                // Golden Cross (Buy Signal)
                if (lastShortSMA <= lastLongSMA && shortSMA > longSMA && !botHolding) {
                    if (signalStrength < skillThreshold) continue; 
                    
                    const buyAmount = gameState.bot.allocatedBalance * tradePercentage; 
                    if (buyAmount > 100) {
                        const fee = buyAmount * getBotFee();
                        if (gameState.bot.allocatedBalance < buyAmount + fee) continue;

                        const quantity = buyAmount / price;
                        gameState.bot.allocatedBalance -= (buyAmount + fee);
                        gameState.bot.holdings[id] = { quantity: quantity, purchasePrice: price };
                        gameState.bot.trades.push({ type: 'BELI', coinId: id, quantity, price });
                    }
                } 
                // Death Cross (Sell Signal)
                else if (lastShortSMA >= lastLongSMA && shortSMA < longSMA && botHolding) {
                    if (signalStrength < skillThreshold) continue;
                    const sellValue = botHolding.quantity * price;
                    const fee = sellValue * getBotFee();
                    gameState.bot.allocatedBalance += (sellValue - fee);
                    gameState.bot.trades.push({ type: 'JUAL', coinId: id, quantity: botHolding.quantity, price });

                    if (price > botHolding.purchasePrice) {
                        gameState.bot.wins++;
                        
                        const extraCoinBonusPercent = 0.25; // 25%
                        const bonusAmount = botHolding.quantity * extraCoinBonusPercent;
                        
                        const userHolding = gameState.portfolio[id] || { quantity: 0, avgPrice: 0 };
                        userHolding.quantity += bonusAmount;
                        gameState.portfolio[id] = userHolding;

                        const cashbackPercent = 0.20; // 20%
                        const tradeValue = botHolding.quantity * botHolding.purchasePrice;
                        const cashbackAmount = tradeValue * cashbackPercent;
                        gameState.balance += cashbackAmount;


                    } else if (price < botHolding.purchasePrice) {
                        gameState.bot.losses++;
                    }
                    
                    delete gameState.bot.holdings[id];
                }
            }
        }


        function updateMarketSimulation() {
            // News Event Management
            // Decrease duration for all active news and filter out expired ones
            gameState.activeNews = gameState.activeNews.map(news => ({ ...news, duration: news.duration - 1 })).filter(news => news.duration > 0);

            // Trigger a new event randomly
            if (Math.random() < 0.10 && gameState.activeNews.length < 5) { // 10% chance, max 5 news items
                const coinIds = Object.keys(cryptoData);
                const randomCoinId = coinIds[Math.floor(Math.random() * coinIds.length)];
                const isPositive = Math.random() > 0.5;
                const positiveNews = ["mengumumkan kemitraan strategis!", "merilis update teknologi besar!", "mendapat dukungan investor besar!"];
                const negativeNews = ["mengalami masalah keamanan.", "dihadapkan pada regulasi baru.", "ditinggalkan oleh pengembang utamanya."];
                
                const newNewsEvent = {
                    coinId: randomCoinId,
                    type: isPositive ? 'positive' : 'negative',
                    text: `[${randomCoinId}] ${isPositive ? positiveNews[Math.floor(Math.random() * positiveNews.length)] : negativeNews[Math.floor(Math.random() * negativeNews.length)]}`,
                    duration: 20 + Math.floor(Math.random() * 30) // Lasts for 20-50 ticks
                };
                gameState.activeNews.push(newNewsEvent);
            }
            
            for (const id in cryptoData) {
                const coin = cryptoData[id];
                const market = gameState.marketPrices[id];
                
                // NPC Trading Simulation
                if (Math.random() < 0.7) { // 70% chance of NPC trade per tick
                    const tradeVolume = coin.marketSupply * 0.001 * Math.random();
                    if (Math.random() > 0.5) { // NPC Buy
                        if (coin.marketSupply + tradeVolume < coin.totalSupply) {
                            coin.marketSupply += tradeVolume;
                            market.pressure += tradeVolume / coin.marketSupply * 10;
                        }
                    } else { // NPC Sell
                        if (coin.marketSupply - tradeVolume > 0) {
                            coin.marketSupply -= tradeVolume;
                            market.pressure -= tradeVolume / coin.marketSupply * 10;
                        }
                    }
                }
                
                // Dynamic Price Calculation
                let priceChange = 0;
                const scarcityFactor = 1 - (coin.marketSupply / coin.totalSupply);
                const pressureFactor = market.pressure / 100;
                
                let newsFactor = 0;
                const relevantNews = gameState.activeNews.find(news => news.coinId === id);
                if (relevantNews) {
                    newsFactor = relevantNews.type === 'positive' ? 0.15 : -0.15;
                }

                const randomFluctuation = (Math.random() - 0.5) * coin.volatility / 10;
                
                const changeMultiplier = randomFluctuation + (pressureFactor * coin.volatility) + (scarcityFactor * 0.01) + newsFactor;
                priceChange = market.price * changeMultiplier;
                
                market.price = Math.max(0.000001, market.price + priceChange);
                
                market.history.push(market.price);
                if (market.history.length > 50) market.history.shift();
                
                market.pressure *= 0.95; // Decay pressure over time
            }
        }

        // --- INIT & LOOP ---
        loadState();
        render(); 
        setInterval(() => {
            updateMarketSimulation();
            processLimitOrders();
            runTradingBot();
            
            // Update staking rewards
            for (const id in gameState.stakedAssets) {
                 const staked = gameState.stakedAssets[id];
                 if(staked.amount > 0) {
                      const APY = 10 + (id.length % 5);
                      const rewardPerSecond = (staked.amount * (APY/100)) / (365 * 24 * 60 * 60);
                      staked.reward += rewardPerSecond * 2; // Interval is 2 seconds
                 }
            }
            
            updateDynamicData();
            if (selectedCoin && document.querySelector('.tab.active').dataset.tab === 'trade') {
                updateChart();
            }
        }, 2000);
        setInterval(saveState, 5000);
    </script>
</body>
</html>
