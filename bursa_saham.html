<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bursa Saham</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style> body { font-family: 'Inter', sans-serif; } </style>
</head>
<body class="bg-gray-900 text-white">
    <div class="container mx-auto p-4 max-w-7xl">
        <header class="bg-gray-800 p-4 rounded-lg mb-4 flex justify-between items-center shadow-lg">
            <h1 class="text-2xl font-bold">Bursa Saham</h1>
            <div id="balance-container" class="text-right">
                <p class="text-sm text-gray-400">Saldo Tunai</p>
                <p id="balance" class="text-2xl font-bold text-green-400">Rp 0</p>
            </div>
        </header>
        <div id="main-content" class="grid grid-cols-1 lg:grid-cols-3 gap-4">
             <div class="lg:col-span-1 bg-gray-800 p-4 rounded-lg shadow-lg">
                <h2 class="text-xl font-bold mb-2">Pasar</h2>
                <div id="stock-market-list" class="space-y-2 max-h-[70vh] overflow-y-auto">
                    <!-- Daftar saham akan di-render di sini -->
                </div>
            </div>
            <div id="detail-view" class="lg:col-span-2 bg-gray-800 p-4 rounded-lg shadow-lg">
                <!-- Detail saham akan di-render di sini -->
                 <p class="text-center text-gray-500">Pilih saham dari daftar untuk melihat detail.</p>
            </div>
        </div>
    </div>
    
    <script>
        let exchangeState = { balance: 0, portfolio: {}, marketPrices: {} };
        let selectedStock = null;
        let stockChart = null;

        const defaultStocks = {
            BBCA: { name: "PT Bank Central Asia Tbk", basePrice: 9500, volatility: 0.05 },
            GOTO: { name: "PT GoTo Gojek Tokopedia Tbk", basePrice: 58, volatility: 0.2 },
            TLKM: { name: "PT Telkom Indonesia (Persero) Tbk", basePrice: 3800, volatility: 0.08 },
            ANTM: { name: "PT Aneka Tambang Tbk", basePrice: 1500, volatility: 0.15 },
        };

        function formatCurrency(num) {
             return `Rp ${Math.floor(num).toLocaleString('id-ID')}`;
        }
        
        function loadState(){
            const savedData = localStorage.getItem('stockExchangeData');
            if (savedData) {
                const loaded = JSON.parse(savedData);
                exchangeState = { ...{ balance: 0, portfolio: {}, marketPrices: {} }, ...loaded };
            }
            // Ensure default stocks are always present in marketPrices
            for(const id in defaultStocks){
                if(!exchangeState.marketPrices[id]){
                    exchangeState.marketPrices[id] = {
                        name: defaultStocks[id].name,
                        price: defaultStocks[id].basePrice,
                        history: Array(50).fill(defaultStocks[id].basePrice)
                    };
                }
            }
        }

        function saveState() {
            localStorage.setItem('stockExchangeData', JSON.stringify(exchangeState));
        }

        function renderStockMarket() {
            const stockMarketListEl = document.getElementById('stock-market-list');
            const marketPrices = exchangeState.marketPrices || {};
            
            stockMarketListEl.innerHTML = Object.keys(marketPrices).map(id => {
                const stock = marketPrices[id];
                const name = stock.name || "Unknown Company";
                const price = stock.price;
                const oldPrice = stock.history[stock.history.length - 2] || price;
                const change = price - oldPrice;
                const color = change >= 0 ? 'text-green-400' : 'text-red-400';
                
                return `
                    <div class="stock-item cursor-pointer p-2 rounded-md hover:bg-gray-700 flex justify-between items-center" data-id="${id}">
                        <div>
                            <p class="font-bold">${id}</p>
                            <p class="text-xs text-gray-400">${name}</p>
                        </div>
                        <div class="text-right">
                            <p class="font-semibold ${color}">${formatCurrency(price)}</p>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderStockDetail() {
            const detailViewEl = document.getElementById('detail-view');
            if (!selectedStock) {
                detailViewEl.innerHTML = `<p class="text-center text-gray-500">Pilih saham dari daftar untuk melihat detail.</p>`;
                return;
            }

            const stock = exchangeState.marketPrices[selectedStock];
            const name = stock.name || "Unknown Company";
            const price = stock.price;
            const ownedLots = exchangeState.portfolio[selectedStock]?.lots || 0;

            detailViewEl.innerHTML = `
                <h2 class="text-2xl font-bold">${name} (${selectedStock})</h2>
                <p class="text-lg font-semibold mb-2">${formatCurrency(price)}</p>
                <div class="h-64 mb-4"><canvas id="stock-chart"></canvas></div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="bg-gray-700 p-4 rounded-lg">
                         <h3 class="text-lg font-bold mb-2">Order</h3>
                         <div class="space-y-3">
                             <div>
                                 <label class="text-sm">Harga per Lembar</label>
                                 <input type="number" id="order-price" class="w-full bg-gray-800 p-2 rounded mt-1" value="${price}">
                             </div>
                             <div>
                                  <label class="text-sm">Jumlah (Lot)</label>
                                 <input type="number" id="order-lot" class="w-full bg-gray-800 p-2 rounded mt-1" placeholder="1 lot = 100 lembar">
                             </div>
                             <p class="text-sm">Total: <span id="order-total">Rp 0</span></p>
                             <div class="flex space-x-2">
                                 <button id="buy-button" class="flex-1 bg-green-600 hover:bg-green-700 font-bold py-2 px-4 rounded">Beli</button>
                                 <button id="sell-button" class="flex-1 bg-red-600 hover:bg-red-700 font-bold py-2 px-4 rounded">Jual</button>
                             </div>
                             <p class="text-xs text-gray-400 mt-2">Dimiliki: ${ownedLots} Lot</p>
                         </div>
                    </div>
                </div>
            `;
            updateChart();
        }

        function updateChart() {
            if(!selectedStock) return;
            const history = exchangeState.marketPrices[selectedStock].history;
            const ctx = document.getElementById('stock-chart').getContext('2d');
            if (stockChart) stockChart.destroy();
            stockChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: history.map((_, i) => i),
                    datasets: [{
                        label: 'Harga',
                        data: history,
                        borderColor: history[history.length-1] >= history[0] ? '#22c55e' : '#ef4444',
                        borderWidth: 2, pointRadius: 0, tension: 0.1
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, scales: { x: { display: false }, y: { ticks: { color: '#9CA3AF' } } }, plugins: { legend: { display: false } } }
            });
        }
        
        function handleOrder(type) {
            if(!selectedStock) return;
            const price = parseInt(document.getElementById('order-price').value);
            const lots = parseInt(document.getElementById('order-lot').value);
            if(isNaN(price) || isNaN(lots) || price <= 0 || lots <= 0) {
                alert("Harga dan Lot harus diisi dengan benar.");
                return;
            }
            const totalCost = price * lots * 100;

            if(type === 'buy') {
                if(exchangeState.balance < totalCost) {
                    alert("Saldo tidak cukup.");
                    return;
                }
                exchangeState.balance -= totalCost;
                const holding = exchangeState.portfolio[selectedStock] || { lots: 0, avgPrice: 0 };
                const newTotalCost = (holding.lots * 100 * holding.avgPrice) + totalCost;
                holding.lots += lots;
                holding.avgPrice = newTotalCost / (holding.lots * 100);
                exchangeState.portfolio[selectedStock] = holding;

            } else { // sell
                const holding = exchangeState.portfolio[selectedStock];
                 if(!holding || holding.lots < lots) {
                    alert("Jumlah lot yang dimiliki tidak cukup.");
                    return;
                }
                exchangeState.balance += totalCost;
                holding.lots -= lots;
                if(holding.lots === 0) delete exchangeState.portfolio[selectedStock];
            }

            document.getElementById('order-lot').value = '';
            saveState();
            renderAll();
        }

        function simulateMarketPrices() {
            for (const id in exchangeState.marketPrices) {
                const stockInfo = exchangeState.marketPrices[id];
                const baseInfo = defaultStocks[id] || { basePrice: stockInfo.price, volatility: 0.1 };
                const change = (Math.random() - 0.5) * baseInfo.basePrice * baseInfo.volatility;
                let newPrice = stockInfo.price + change;
                newPrice = Math.max(newPrice, 1);
                stockInfo.price = Math.round(newPrice);
                stockInfo.history.push(stockInfo.price);
                if (stockInfo.history.length > 50) stockInfo.history.shift();
            }
        }
        
        function renderAll(){
            document.getElementById('balance').textContent = formatCurrency(exchangeState.balance);
            renderStockMarket();
            if(selectedStock) {
                renderStockDetail();
            }
        }

        document.getElementById('main-content').addEventListener('click', (e) => {
            const stockItem = e.target.closest('.stock-item');
            if (stockItem) {
                selectedStock = stockItem.dataset.id;
                renderStockDetail();
            }
            if (e.target.id === 'buy-button') {
                handleOrder('buy');
            }
            if (e.target.id === 'sell-button') {
                handleOrder('sell');
            }
        });

        document.getElementById('main-content').addEventListener('input', (e) => {
             if (e.target.id === 'order-price' || e.target.id === 'order-lot') {
                const price = parseInt(document.getElementById('order-price')?.value) || 0;
                const lots = parseInt(document.getElementById('order-lot')?.value) || 0;
                const totalEl = document.getElementById('order-total');
                if(totalEl) totalEl.textContent = formatCurrency(price * lots * 100);
            }
        });


        window.addEventListener('focus', () => {
            loadState();
            renderAll();
        });
        
        loadState();
        renderAll();

        setInterval(() => {
            simulateMarketPrices();
            renderAll();
        }, 2000);
        setInterval(saveState, 5000);
    </script>
</body>
</html>

