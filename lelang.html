<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Platform Lelang</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style> 
        body { font-family: 'Inter', sans-serif; } 
        .timer-ended { color: #ef4444; }
        .toast {
            position: fixed;
            bottom: -100px;
            left: 50%;
            transform: translateX(-50%);
            padding: 12px 24px;
            border-radius: 8px;
            color: white;
            z-index: 1000;
            transition: bottom 0.5s ease-in-out;
            font-size: 0.9rem;
        }
        .toast.show { bottom: 20px; }
        .toast.success { background-color: #22c55e; }
        .toast.error { background-color: #ef4444; }
        .toast.info { background-color: #3b82f6; }
    </style>
</head>
<body class="bg-gray-900 text-white">
    <div id="toast-container"></div>
    <div class="container mx-auto p-4 max-w-7xl">
        <header class="bg-gray-800 p-4 rounded-lg mb-4 flex flex-col md:flex-row md:justify-between md:items-center shadow-lg gap-4">
            <div>
                <h1 class="text-2xl font-bold text-purple-400 text-center md:text-left">Platform Lelang</h1>
                <a href="index.html" class="text-sm text-yellow-400 hover:underline block text-center md:text-left">&larr; Kembali ke Idle Tycoon</a>
            </div>
            <div class="flex items-center justify-center gap-4">
                <div id="balance-container" class="text-right">
                    <p class="text-sm text-gray-400">Saldo Lelang Anda</p>
                    <p id="balance" class="text-2xl font-bold text-green-400">Rp 0</p>
                </div>
                <div>
                    <button id="reset-button" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded text-sm">Reset</button>
                </div>
            </div>
        </header>
        <div id="main-content" class="grid grid-cols-1 lg:grid-cols-3 gap-4">
             <div class="lg:col-span-1 bg-gray-800 p-4 rounded-lg shadow-lg flex flex-col">
                <h2 class="text-xl font-bold mb-2">Status Lelang</h2>
                <div id="auction-status" class="space-y-2 mb-4">
                    <!-- Status lelang akan di-render di sini -->
                </div>
                <hr class="border-gray-600 my-4">
                <h2 class="text-xl font-bold mb-2">Inventaris Anda</h2>
                <div id="inventory" class="space-y-2 overflow-y-auto flex-grow">
                    <!-- Inventaris akan di-render di sini -->
                </div>
            </div>
            <div id="detail-view" class="lg:col-span-2 bg-gray-800 p-4 rounded-lg shadow-lg">
                <!-- Tampilan detail lelang akan di-render di sini -->
            </div>
        </div>
    </div>
    
    <script>
        const AUCTION_INTERVAL = 5 * 60 * 1000; // 5 menit
        const ITEM_DURATION = 1 * 60 * 1000;   // 1 menit
        const RESULT_DISPLAY_DURATION = 4000; // 4 detik

        let auctionState = {
            balance: 0,
            inventory: {},
            nextSessionTime: 0,
            isSessionActive: false,
            auctionQueue: [],
            currentItem: null,
            lastResult: null 
        };

        const availableItems = {
            ITEM001: { name: "Lukisan Antik 'Senja'", basePrice: 15000000, icon: 'ðŸ–¼ï¸' },
            ITEM002: { name: "Mobil Klasik 'Mustang 68'", basePrice: 500000000, icon: 'ðŸš—' },
            ITEM003: { name: "Jam Tangan 'Rolex Submariner'", basePrice: 250000000, icon: 'âŒš' },
            ITEM004: { name: "Gitar Elektrik 'Fender Stratocaster'", basePrice: 45000000, icon: 'ðŸŽ¸' },
            ITEM005: { name: "Batu Permata Langka", basePrice: 80000000, icon: 'ðŸ’Ž' },
            ITEM006: { name: "Koin Emas Kuno", basePrice: 30000000, icon: 'ðŸª™' }
        };
        
        function showToast(message, type = 'info') {
            const toastContainer = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            toastContainer.appendChild(toast);

            setTimeout(() => toast.classList.add('show'), 100);
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 500);
            }, 3000);
        }

        function formatCurrency(num) {
             return `Rp ${Math.floor(num).toLocaleString('id-ID')}`;
        }

        function formatDuration(ms) {
            if (ms <= 0) return `<span class="timer-ended font-bold">00:00</span>`;
            const totalSeconds = Math.floor(ms / 1000);
            const m = Math.floor(totalSeconds / 60).toString().padStart(2, '0');
            const s = Math.floor(totalSeconds % 60).toString().padStart(2, '0');
            return `${m}:${s}`;
        }
        
        function loadState(){
            const savedData = localStorage.getItem('auctionPlatformData');
            if (savedData) {
                auctionState = { ...auctionState, ...JSON.parse(savedData) };
            }
            const exchangeData = JSON.parse(localStorage.getItem('stockExchangeData'));
            if (exchangeData && exchangeData.balance) {
                auctionState.balance = exchangeData.balance;
            }
            if (auctionState.nextSessionTime === 0 || auctionState.nextSessionTime < Date.now()) {
                 auctionState.nextSessionTime = Date.now() + AUCTION_INTERVAL;
            }
        }

        function saveState() {
            localStorage.setItem('auctionPlatformData', JSON.stringify(auctionState));
            const exchangeData = JSON.parse(localStorage.getItem('stockExchangeData')) || {};
            exchangeData.balance = auctionState.balance;
            localStorage.setItem('stockExchangeData', JSON.stringify(exchangeData));
        }

        function startAuctionSession() {
            showToast("Sesi lelang baru telah dimulai!", 'info');
            auctionState.isSessionActive = true;
            
            const itemIds = Object.keys(availableItems);
            for (let i = itemIds.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [itemIds[i], itemIds[j]] = [itemIds[j], itemIds[i]];
            }
            
            const itemsToAuctionCount = 2 + Math.floor(Math.random() * 2); 
            auctionState.auctionQueue = itemIds.slice(0, itemsToAuctionCount);
            
            startNextItemAuction();
        }

        function startNextItemAuction() {
            auctionState.lastResult = null;
            if (auctionState.auctionQueue.length === 0) {
                endAuctionSession();
                return;
            }
            
            const itemId = auctionState.auctionQueue.shift();
            const itemInfo = availableItems[itemId];
            
            auctionState.currentItem = {
                id: itemId,
                ...itemInfo,
                currentBid: itemInfo.basePrice,
                highestBidder: 'Belum ada',
                endTime: Date.now() + ITEM_DURATION
            };
        }
        
        function endCurrentItemAuction() {
            const item = auctionState.currentItem;
            if (!item) return;

            if (item.highestBidder === 'Anda') {
                const inventoryItem = auctionState.inventory[item.id] || { ...item, quantity: 0, value: 0 };
                inventoryItem.quantity += 1;
                inventoryItem.value = item.currentBid;
                auctionState.inventory[item.id] = inventoryItem;
                showToast(`Selamat! Anda memenangkan ${item.name}!`, 'success');
            } else if (item.highestBidder !== 'Belum ada') {
                 showToast(`${item.name} dimenangkan penawar lain.`, 'error');
            } else {
                 showToast(`${item.name} tidak terjual.`, 'info');
            }
            
            auctionState.lastResult = {
                name: item.name,
                icon: item.icon,
                winner: item.highestBidder,
                winningBid: item.currentBid,
                displayUntil: Date.now() + RESULT_DISPLAY_DURATION
            };

            auctionState.currentItem = null;
            saveState();
        }

        function endAuctionSession() {
            auctionState.isSessionActive = false;
            auctionState.currentItem = null;
            auctionState.nextSessionTime = Date.now() + AUCTION_INTERVAL;
            showToast("Sesi lelang berakhir. Sesi berikutnya dalam 5 menit.", 'info');
        }

        function renderStatus() {
            const statusEl = document.getElementById('auction-status');
            if (auctionState.isSessionActive) {
                let queueHTML = auctionState.auctionQueue.map(id => {
                    const item = availableItems[id];
                    return `<div class="p-2 bg-gray-700 rounded-md flex items-center"><span class="text-xl mr-2">${item.icon}</span><span class="text-sm">${item.name}</span></div>`;
                }).join('');

                let currentItemStatusHTML = '';
                if (auctionState.currentItem) {
                    currentItemStatusHTML = `
                    <div>
                        <p class="text-sm text-gray-400">Sedang Dilelang:</p>
                        <div class="p-2 bg-purple-900/50 border border-purple-500 rounded-md flex items-center">
                             <span class="text-xl mr-2">${auctionState.currentItem.icon}</span>
                             <span>${auctionState.currentItem.name}</span>
                        </div>
                    </div>`;
                } else if (auctionState.lastResult) {
                    currentItemStatusHTML = '<p>Menampilkan hasil lelang...</p>';
                }

                statusEl.innerHTML = `
                    <div>
                        <h3 class="font-bold text-lg text-green-400">Sesi Lelang Aktif</h3>
                    </div>
                    ${currentItemStatusHTML}
                    ${auctionState.auctionQueue.length > 0 ? `
                    <div>
                        <p class="text-sm text-gray-400 mt-4">Berikutnya:</p>
                        <div class="space-y-1">${queueHTML}</div>
                    </div>` : ''}
                `;
            } else {
                const remainingTime = auctionState.nextSessionTime - Date.now();
                statusEl.innerHTML = `
                    <h3 class="font-bold text-lg text-yellow-400">Lelang Berikutnya Dalam:</h3>
                    <p class="text-4xl font-mono countdown-timer">${formatDuration(remainingTime)}</p>
                `;
            }
        }

        function renderInventory() {
            const inventoryEl = document.getElementById('inventory');
            const items = Object.values(auctionState.inventory);
            if (items.length === 0) {
                inventoryEl.innerHTML = `<p class="text-center text-gray-500">Anda belum memiliki barang.</p>`;
                return;
            }
            inventoryEl.innerHTML = items.map(item => `
                <div class="p-2 bg-gray-700 rounded-md flex items-center justify-between">
                    <div class="flex items-center">
                        <span class="text-2xl mr-3">${item.icon}</span>
                        <div>
                            <p class="font-semibold text-sm">${item.name}</p>
                            <p class="text-xs text-gray-400">Harga Beli: ${formatCurrency(item.value)}</p>
                        </div>
                    </div>
                    <span class="font-bold text-purple-400">x${item.quantity}</span>
                </div>
            `).join('');
        }

        function renderItemDetail() {
            const detailViewEl = document.getElementById('detail-view');
            const item = auctionState.currentItem;
            const lastResult = auctionState.lastResult;

            if (lastResult) {
                const winnerText = lastResult.winner === 'Anda' 
                    ? `<span class="font-bold text-green-400">Anda!</span>` 
                    : `<span class="font-bold text-red-400">${lastResult.winner}</span>`;
                
                const resultMessage = lastResult.winner !== 'Belum ada'
                    ? `<h3 class="text-3xl font-bold">Pemenang: ${winnerText}</h3>
                       <p class="text-lg">dengan tawaran <span class="font-bold text-yellow-400">${formatCurrency(lastResult.winningBid)}</span></p>`
                    : `<h3 class="text-3xl font-bold text-gray-400">Tidak Terjual</h3>`;

                detailViewEl.innerHTML = `
                    <div class="text-center h-full flex flex-col justify-center items-center">
                        <p class="text-gray-400 text-xl mb-2">Lelang untuk ${lastResult.name} ${lastResult.icon} telah berakhir!</p>
                        ${resultMessage}
                        <p class="text-gray-500 mt-8">Mempersiapkan lelang berikutnya...</p>
                        <div class="w-10 h-10 border-4 border-dashed rounded-full animate-spin border-purple-400 mt-2"></div>
                    </div>`;
                return;
            }

            if (!item) {
                detailViewEl.innerHTML = `<div class="text-center h-full flex flex-col justify-center items-center"><p class="text-gray-500 text-2xl">Menunggu sesi lelang berikutnya...</p><p class="text-5xl mt-4 font-mono countdown-timer">${formatDuration(auctionState.nextSessionTime - Date.now())}</p></div>`;
                return;
            }

            const remainingMs = item.endTime - Date.now();
            const isHighestBidder = item.highestBidder === 'Anda';
            const canAffordNextBid = auctionState.balance > item.currentBid;

            detailViewEl.innerHTML = `
                <div class="flex items-center mb-4">
                    <span class="text-6xl mr-4">${item.icon}</span>
                    <div>
                        <h2 class="text-3xl font-bold">${item.name}</h2>
                        <p class="text-lg text-gray-400">Waktu Tersisa: <span class="font-mono item-timer font-bold text-2xl">${formatDuration(remainingMs)}</span></p>
                    </div>
                </div>

                <div class="bg-gray-700 p-4 rounded-lg">
                    <h3 class="font-bold text-xl mb-2">Status Lelang</h3>
                    <p>Tawaran tertinggi: <span class="font-bold text-2xl text-yellow-400">${formatCurrency(item.currentBid)}</span></p>
                    <p>Penawar tertinggi: <span class="font-bold ${isHighestBidder ? 'text-green-400' : ''}">${item.highestBidder}</span></p>
                    
                    <div class="mt-4">
                        <label for="bid-amount" class="block text-sm font-medium text-gray-300">Jumlah Tawaran Anda:</label>
                        <input type="number" id="bid-amount" class="w-full bg-gray-800 p-2 rounded mt-1 border border-gray-600 focus:outline-none focus:ring-2 focus:ring-purple-500" placeholder="Masukkan jumlah tawaran">
                        <div class="flex space-x-2 mt-2">
                            <button class="quick-bid-btn flex-1 bg-gray-600 hover:bg-gray-500 text-xs font-bold py-1 px-2 rounded" data-type="min">Tawaran Min</button>
                            <button class="quick-bid-btn flex-1 bg-gray-600 hover:bg-gray-500 text-xs font-bold py-1 px-2 rounded" data-type="percent" data-value="0.05">+5%</button>
                            <button class="quick-bid-btn flex-1 bg-gray-600 hover:bg-gray-500 text-xs font-bold py-1 px-2 rounded" data-type="percent" data-value="0.10">+10%</button>
                        </div>
                        <button id="place-bid-btn" class="w-full mt-2 font-bold py-3 px-4 rounded transition-colors ${!canAffordNextBid || remainingMs <= 0 ? 'bg-gray-600 cursor-not-allowed' : 'bg-purple-600 hover:bg-purple-700'}" ${!canAffordNextBid || remainingMs <= 0 ? 'disabled' : ''}>
                            ${remainingMs > 0 ? 'Ajukan Tawaran' : 'Lelang Berakhir'}
                        </button>
                    </div>
                </div>
            `;
        }
        
        function handleQuickBid(type, value) {
            const item = auctionState.currentItem;
            if (!item) return;

            const bidInput = document.getElementById('bid-amount');
            if (!bidInput) return;

            const currentBid = item.currentBid;
            let newBid = 0;
            
            const minIncrement = Math.max(1000, currentBid * 0.01);

            if (type === 'min') {
                newBid = currentBid + minIncrement;
            } else if (type === 'percent') {
                const percent = parseFloat(value);
                newBid = currentBid * (1 + percent);
            }
            
            bidInput.value = Math.ceil(newBid / 1000) * 1000;
        }

        function handleBid() {
            const item = auctionState.currentItem;
            if (!item) return;

            const bidInput = document.getElementById('bid-amount');
            const bidAmount = parseFloat(bidInput.value);

            if (isNaN(bidAmount)) { showToast("Masukkan jumlah tawaran yang valid.", 'error'); return; }
            if (bidAmount <= item.currentBid) { showToast("Tawaran harus lebih tinggi dari saat ini.", 'error'); return; }
            if (auctionState.balance < bidAmount) { showToast("Saldo Anda tidak cukup.", 'error'); return; }

            if (item.highestBidder === 'Anda') {
                auctionState.balance += item.currentBid;
            }

            auctionState.balance -= bidAmount;
            item.currentBid = bidAmount;
            item.highestBidder = 'Anda';
            
            saveState();
        }

        function gameLoop() {
            const now = Date.now();
            
            // State transition: From result display to next state
            if (auctionState.lastResult && now >= auctionState.lastResult.displayUntil) {
                if (auctionState.auctionQueue.length > 0) {
                    startNextItemAuction();
                } else {
                    endAuctionSession();
                }
            }
            
            // State transition: Start a new session
            if (!auctionState.isSessionActive && !auctionState.lastResult && now >= auctionState.nextSessionTime) {
                startAuctionSession();
            }

            // State transition: End an item auction
            if(auctionState.isSessionActive && auctionState.currentItem && now >= auctionState.currentItem.endTime) {
                endCurrentItemAuction();
            }
            
            renderAll();
        }

        function renderAll(){
            document.getElementById('balance').textContent = formatCurrency(auctionState.balance);
            renderStatus();
            renderItemDetail();
            renderInventory();
        }

        document.getElementById('main-content').addEventListener('click', (e) => {
            if (e.target.id === 'place-bid-btn') {
                handleBid();
            }
            const quickBidBtn = e.target.closest('.quick-bid-btn');
            if (quickBidBtn) {
                e.preventDefault();
                handleQuickBid(quickBidBtn.dataset.type, quickBidBtn.dataset.value);
            }
        });

        window.addEventListener('focus', loadState);

        document.getElementById('reset-button').addEventListener('click', () => {
            localStorage.removeItem('auctionPlatformData');
            showToast("Data lelang telah direset.", "info");
            setTimeout(() => location.reload(), 1500); 
        });
        
        loadState();
        setInterval(gameLoop, 1000);
        setInterval(saveState, 5000);
    </script>
</body>
</html>

